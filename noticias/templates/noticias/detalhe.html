{% extends "base.html" %}
{% load static %}

{% block title %}{{ noticia.titulo }} — JC{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'noticias/css/detalhe.css' %}">
{% endblock %}

{% block content %}
<article class="art-wrap" itemscope itemtype="https://schema.org/NewsArticle">

  <!-- Kicker -->
  <header class="art-top">
    <div class="art-kicker">
      {% if noticia.categoria %}
        <span class="kicker-link">{{ noticia.categoria.nome }}</span>
      {% endif %}
      <span class="kicker-sep">|</span>
      <span class="kicker-type">NOTÍCIA</span>
    </div>

    <h1 class="art-title" itemprop="headline">{{ noticia.titulo }}</h1>

    <div class="art-byline">
      <span class="by">Por</span>
      <span class="who" itemprop="author" itemscope itemtype="https://schema.org/Organization">
        <span itemprop="name">{{ noticia.autor_nome|default:"JC" }}</span>
      </span>
    </div>

    <!-- Ações -->
    <div class="art-actions">
      {% if noticia.pk %}
      <form method="post" action="{% url 'noticias:toggle_salvo' noticia.pk %}" class="act" aria-label="Salvar matéria">
        {% csrf_token %}
        <button class="btn-icon" type="submit" title="Salvar">
          <svg viewBox="0 0 24 24" aria-hidden="true" class="ico"><path d="M6 2h12a2 2 0 0 1 2 2v18l-8-4-8 4V4a 2 2 0 0 1 2-2z"/></svg>
        </button>
      </form>
      {% endif %}

      <button class="btn-icon" type="button" title="Compartilhar" id="shareBtn" aria-label="Compartilhar">
        <svg viewBox="0 0 24 24" aria-hidden="true" class="ico"><path d="M18 8a3 3 0 1 0-2.83-2H10a2 2 0 0 0-2 2v3.17a3 3 0 1 0 0 3.66V18a2 2 0 0 0 2 2h5.17A3 3 0 1 0 18 18H11v-2.17A3.001 3.001 0 0 0 12 12a3 3 0 0 0-1-2.24V8h4.17A3 3 0 0 0 18 8z"/></svg>
      </button>
    </div>
  </header>

  <!-- Imagem principal -->
  {% if noticia.imagem %}
  <figure class="art-hero" itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
    {% if noticia.alt_imagem %}
      <img src="{{ noticia.imagem.url }}" alt="{{ noticia.alt_imagem }}" class="hero-img">
    {% else %}
      <img src="{{ noticia.imagem.url }}" alt="Imagem de {{ noticia.titulo }}" class="hero-img">
    {% endif %}
    {% if noticia.legenda_imagem or noticia.credito_imagem %}
    <figcaption class="hero-cap">
      <span class="cap-txt">{{ noticia.legenda_imagem }}</span>
      {% if noticia.credito_imagem %}
        <span class="cap-credit"> — {{ noticia.credito_imagem }}</span>
      {% endif %}
    </figcaption>
    {% endif %}
    <meta itemprop="url" content="{{ noticia.imagem.url }}">
  </figure>
  {% endif %}

  <!-- Lead -->
  {% if noticia.resumo %}
  <p class="art-lead">{{ noticia.resumo }}</p>
  {% endif %}

  <!-- Times -->
  <div class="art-times">
    <time itemprop="datePublished" datetime="{{ noticia.publicado_em|date:'c' }}">
      Publicado em {{ noticia.publicado_em|date:"d/m/Y" }} às {{ noticia.publicado_em|date:"H:i" }}
    </time>
    {% if noticia.atualizado_em and noticia.atualizado_em > noticia.publicado_em %}
      <span class="sep">|</span>
      <time itemprop="dateModified" datetime="{{ noticia.atualizado_em|date:'c' }}">
        Atualizado em {{ noticia.atualizado_em|date:"d/m/Y" }} às {{ noticia.atualizado_em|date:"H:i" }}
      </time>
    {% endif %}
  </div>

  <!-- Corpo -->
  <div class="art-body" itemprop="articleBody">
    {% if noticia.conteudo_html %}
      {{ noticia.conteudo_html|safe }}
    {% else %}
      {% for p in noticia.paragrafos.all %}
        <p>{{ p.texto }}</p>
      {% empty %}
        <p>{{ noticia.conteudo|linebreaks }}</p>
      {% endfor %}
    {% endif %}
  </div>

  <!-- ===== LEIA TAMBÉM ===== -->
  {% if relacionadas %}
  <section class="art-related">
    <h2 class="related-title">LEIA TAMBÉM</h2>
    <div class="related-grid">
      {% for rel in relacionadas %}
      <a href="{% url 'noticias:noticia_detalhe' rel.pk %}" class="related-card">
        {% if rel.imagem %}
        <img src="{{ rel.imagem.url }}" alt="{{ rel.alt_imagem|default:rel.titulo }}" class="related-img">
        {% endif %}
        <div class="related-info">
          {% if rel.categoria %}
          <p class="related-cat">{{ rel.categoria.nome|upper }}</p>
          {% endif %}
          <h3 class="related-head">{{ rel.titulo }}</h3>
          <p class="related-desc">{{ rel.resumo|default:rel.olho|default:rel.titulo|truncatewords:22 }}</p>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- ===== COMPARTILHE + SALVAR ===== -->
  <section class="art-share">
    <h2 class="share-title">Compartilhe</h2>
    <div class="share-icons">
      <a href="https://api.whatsapp.com/send?text={{ noticia.titulo|urlencode }}%20{{ request.build_absolute_uri }}" target="_blank" rel="noopener" class="share-btn" aria-label="WhatsApp">
        <img src="{% static 'noticias/img/whatsapp.svg' %}" alt="WhatsApp">
      </a>
      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" rel="noopener" class="share-btn" aria-label="Facebook">
        <img src="{% static 'noticias/img/facebook.svg' %}" alt="Facebook">
      </a>
      <a href="https://www.instagram.com/" target="_blank" rel="noopener" class="share-btn" aria-label="Instagram">
        <img src="{% static 'noticias/img/instagram.svg' %}" alt="Instagram">
      </a>
      <button type="button" class="share-btn" id="copyLink" title="Copiar link" aria-label="Copiar link">
        <img src="{% static 'noticias/img/share.svg' %}" alt="Copiar link">
      </button>
    </div>

    {% if noticia.pk %}
    <form method="post" action="{% url 'noticias:toggle_salvo' noticia.pk %}">
      {% csrf_token %}
      <button class="save-main" type="submit">
        <svg viewBox="0 0 24 24" class="save-ico"><path d="M6 2h12a2 2 0 0 1 2 2v18l-8-4-8 4V4a2 2 0 0 1 2-2z"/></svg>
        <span>Salvar</span>
      </button>
    </form>
    {% endif %}
  </section>

  <!-- ===== TAGS ===== -->
  {% with noticia.tags.all as tags %}
  {% if tags %}
  <section class="art-tags">
    <h3 class="tags-title">Tags</h3>
    <div class="tags-wrap">
      {% for tag in tags %}
      <span class="tag-chip">{{ tag.nome|upper }}</span>
      {% endfor %}
    </div>
  </section>
  {% endif %}
  {% endwith %}

</article>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
  // Web Share (mobile) + fallback
  (function () {
    var btn = document.getElementById('shareBtn');
    if (btn) {
      btn.addEventListener('click', async function () {
        const data = { title: document.title, text: "{{ noticia.titulo|escapejs }}", url: window.location.href };
        if (navigator.share) { try { await navigator.share(data); } catch(e) {} }
        else { try { await navigator.clipboard.writeText(data.url); } catch(e) {} }
      });
    }
  })();

  // Copiar link
  document.getElementById("copyLink")?.addEventListener("click", async () => {
    try {
      await navigator.clipboard.writeText(window.location.href);
      alert("Link copiado!");
    } catch (e) {}
  });
</script>
{% endblock %}
