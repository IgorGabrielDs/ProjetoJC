{% extends "base.html" %}
{% load static %}

{% block title %}{{ noticia.titulo }} — JC{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'noticias/css/article.css' %}">
{% endblock %}

{% block content %}
<article class="art-wrap" itemscope itemtype="https://schema.org/NewsArticle">

  <!-- Kicker + ações (topo, linha única) + título -->
  <header class="art-top">
    <div class="art-topbar">
      <div class="art-kicker">
        {% if noticia.assuntos.first %}
          <span class="kicker-link">{{ noticia.assuntos.first.nome }}</span>
        {% endif %}
        <span class="kicker-sep">|</span>
        <span class="kicker-type">NOTÍCIA</span>
      </div>

      <div class="art-actions">
        {% if noticia.pk %}
        <form method="post"
              action="{% url 'noticias:toggle_salvo' noticia.pk %}"
              class="act"
              aria-label="Salvar matéria">
          {% csrf_token %}
          <!-- ESTRELA DE SALVAR (estado vem do backend + salvar.js) -->
          <button
            class="btn-icon btn-save salvar-btn{% if is_saved %} is-saved{% endif %}"
            type="submit"
            title="{% if is_saved %}Remover dos salvos{% else %}Salvar para ler mais tarde{% endif %}"
            aria-label="{% if is_saved %}Remover dos salvos{% else %}Salvar para ler mais tarde{% endif %}"
            aria-pressed="{{ is_saved|yesno:'true,false' }}"
            data-url="{% url 'noticias:toggle_salvo' noticia.pk %}"
            data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
            data-login-url="{% url 'login' %}?next={{ request.path }}">
            <svg viewBox="0 0 24 24" aria-hidden="true" class="ico ico-star">
              <!-- contorno -->
              <path class="star-outline"
                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
              <!-- preenchimento -->
              <path class="star-fill"
                    d="M12 17.27L18.18 21l-1.64-7.03L22 9.24l-7.19-.61L12 2 9.19 8.63 2 9.24l5.46 4.73L5.82 21z"/>
            </svg>
          </button>
        </form>
        {% endif %}

        <!-- COMPARTILHAR (novo ícone) -->
        <button class="btn-icon btn-share"
                type="button"
                title="Compartilhar"
                id="shareBtn"
                aria-label="Compartilhar">
          <svg viewBox="0 0 24 24" aria-hidden="true" class="ico ico-share">
            <!-- caixinha -->
            <path d="M8 5h6a3 3 0 0 1 3 3v9a3 3 0 0 1-3 3H8a3 3 0 0 1-3-3V8a3 3 0 0 1 3-3z"/>
            <!-- seta saindo -->
            <path d="M14 5V3h7v7h-2V7.83l-6.3 6.3-1.4-1.41L17.6 6H14z"/>
          </svg>
        </button>
      </div>
    </div>

    <h1 class="art-title" itemprop="headline">{{ noticia.titulo }}</h1>
  </header>

  <!-- Imagem principal (hero) -->
  {% if noticia.imagem %}
  <figure class="art-hero" itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
    {% if noticia.legenda %}
      <img src="{{ noticia.imagem.url }}" alt="{{ noticia.legenda }}" class="hero-img">
    {% else %}
      <img src="{{ noticia.imagem.url }}" alt="Imagem de {{ noticia.titulo }}" class="hero-img">
    {% endif %}
    {% if noticia.legenda or noticia.credito_imagem %}
    <figcaption class="hero-cap">
      <span class="cap-txt">{{ noticia.legenda }}</span>
      {% if noticia.credito_imagem %}
        <span class="cap-credit"> — {{ noticia.credito_imagem }}</span>
      {% endif %}
    </figcaption>
    {% endif %}
    <meta itemprop="url" content="{{ noticia.imagem.url }}">
  </figure>
  {% endif %}

  <!-- Linha de data/atualização/autor (logo abaixo da imagem) -->
  <div class="art-times">
    <time itemprop="datePublished" datetime="{{ noticia.criado_em|date:'c' }}">
      Publicado em {{ noticia.criado_em|date:"d/m/Y" }} às {{ noticia.criado_em|date:"H:i" }}
    </time>
    {% if noticia.atualizado_em and noticia.atualizado_em > noticia.criado_em %}
      <span class="sep">|</span>
      <time itemprop="dateModified" datetime="{{ noticia.atualizado_em|date:'c' }}">
        Atualizado em {{ noticia.atualizado_em|date:"d/m/Y" }} às {{ noticia.atualizado_em|date:"H:i" }}
      </time>
    {% endif %}
    <span class="sep">|</span>
    <span class="byline">
      Por: <span class="who" itemprop="author" itemscope itemtype="https://schema.org/Organization">
        <span itemprop="name">{{ noticia.autor|default:"JC" }}</span>
      </span>
    </span>
  </div>

  <!-- Corpo da matéria com “Continuar Lendo” progressivo -->
  <div class="art-body-wrapper" id="artBodyWrapper">
    <div class="art-body" id="artBody" itemprop="articleBody">
      {{ noticia.conteudo|linebreaks }}
    </div>
  </div>

  <button type="button" class="read-more-btn" id="readMoreBtn">
    <span class="read-more-label">Continuar Lendo</span>
    <span class="read-more-chevron"></span>
  </button>

  {# ============================= #}
  {# ===== RESUMO DA NOTÍCIA ===== #}
  {# ============================= #}
  {% with noticia.conteudo|default_if_none:""|wordcount as total_palavras %}
  <section class="art-resumo" aria-labelledby="resumo-titulo">
    <h2 id="resumo-titulo" class="resumo-title">Resumo da notícia</h2>

    <div id="resumo-action" data-url="{% url 'noticias:resumir_noticia' noticia.pk %}">
      {% if total_palavras < 300 %}
        <button
          type="button"
          id="btn-resumo"
          class="resumo-btn"
          disabled
          title="Texto curto demais para resumir"
        >
          Resumir
        </button>
        <p id="resumo-status" class="resumo-status">
          Texto curto demais para resumir.
        </p>
      {% else %}
        <button
          type="button"
          id="btn-resumo"
          class="resumo-btn"
        >
          Resumir
        </button>
        <p id="resumo-status" class="resumo-status" aria-live="polite"></p>
      {% endif %}
    </div>

    <aside
      id="resumo-panel"
      class="resumo-panel"
      hidden
      aria-hidden="true"
      aria-label="Resumo gerado automaticamente"
    >
      <header class="resumo-header">
        <strong>Resumo gerado automaticamente</strong>
        <button type="button" id="btn-fechar" class="resumo-close">
          Fechar
        </button>
      </header>
      <p id="resumo-text" class="resumo-text"></p>
      <p id="resumo-meta" class="resumo-meta"></p>
      <button type="button" id="btn-copiar" class="resumo-copy">
        Copiar resumo
      </button>
    </aside>
  </section>
  {% endwith %}

  <!-- ============================= -->
  <!-- ===== BLOCO DA ENQUETE ===== -->
  <!-- ============================= -->
  {% if enquete_data %}
  <section class="enquete-box" aria-labelledby="enquete-titulo-{{ enquete_data.obj.pk }}">
    <h2 class="enquete-titulo" id="enquete-titulo-{{ enquete_data.obj.pk }}">
      {{ enquete_data.obj.titulo }}
    </h2>

    {% if user.is_authenticated %}

      {% if enquete_data.usuario_ja_votou %}
        <div class="enquete-resultados">
          {% for op in enquete_data.opcoes %}
            <div class="enquete-opcao-resultado {% if op.id == enquete_data.voto_usuario_id %}enquete-voto-usuario{% endif %}">
              <div class="info-wrapper">
                <span class="texto-opcao">{{ op.texto }}</span>
                <span class="percentual">{{ op.percentual }}%</span>
              </div>
              <div class="enquete-barra">
                <div class="enquete-barra-preenchimento" style="width: {{ op.percentual }}%;"></div>
              </div>
            </div>
          {% endfor %}
          <span class="enquete-total-votos">Total de {{ enquete_data.total_votos }} votos.</span>
        </div>
      {% else %}
        <form class="enquete-form" method="POST" action="{% url 'noticias:votar_enquete' enquete_data.obj.pk %}">
          {% csrf_token %}
          <fieldset>
            <legend class="visually-hidden">Opções da enquete</legend>
            {% for op in enquete_data.opcoes %}
              <div class="enquete-opcao-radio">
                <input type="radio" name="opcao_enquete" value="{{ op.id }}" id="op-{{ op.id }}" required>
                <label for="op-{{ op.id }}">{{ op.texto }}</label>
              </div>
            {% empty %}
              <p>Não há opções nesta enquete no momento.</p>
            {% endfor %}
          </fieldset>
          {% if enquete_data.opcoes %}
            <button class="enquete-btn" type="submit">Votar</button>
          {% endif %}
        </form>
      {% endif %}

    {% else %}
      <div class="enquete-resultados">
        {% for op in enquete_data.opcoes %}
          <div class="enquete-opcao-resultado">
            <div class="info-wrapper">
              <span class="texto-opcao">{{ op.texto }}</span>
              <span class="percentual">{{ op.percentual }}%</span>
            </div>
            <div class="enquete-barra">
              <div class="enquete-barra-preenchimento" style="width: {{ op.percentual }}%;"></div>
            </div>
          </div>
        {% endfor %}
      </div>

      <p class="enquete-login-aviso">
        <a href="{% url 'login' %}?next={{ request.path }}">Faça login</a> para votar nesta enquete.
      </p>
      <span class="enquete-total-votos">Total de {{ enquete_data.total_votos }} votos.</span>
    {% endif %}
  </section>
  {% endif %}
  <!-- ===== FIM DA ENQUETE ===== -->

  <!-- ===== LEIA TAMBÉM ===== -->
  {% if relacionadas %}
  <section class="art-related">
    <h2 class="related-title">LEIA TAMBÉM</h2>
    <div class="related-grid">
      {% for rel in relacionadas %}
      <a href="{% url 'noticias:noticia_detalhe' rel.pk %}" class="related-card">
        {% if rel.imagem %}
          {% if rel.legenda %}
            <img src="{{ rel.imagem.url }}" alt="{{ rel.legenda }}" class="related-img">
          {% else %}
            <img src="{{ rel.imagem.url }}" alt="{{ rel.titulo }}" class="related-img">
          {% endif %}
        {% endif %}
        <div class="related-info">
          {% if rel.assuntos.first %}
            <p class="related-cat">{{ rel.assuntos.first.nome|upper }}</p>
          {% endif %}
          <h3 class="related-head">{{ rel.titulo }}</h3>
          <p class="related-desc">
            {{ rel.resumo|default:rel.conteudo|default:rel.titulo|truncatewords:22 }}
          </p>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- ===== COMPARTILHE + SALVAR ===== -->
  <section class="art-share">
    <h2 class="share-title">Compartilhe</h2>
    <div class="share-icons">
      <a href="https://api.whatsapp.com/send?text={{ noticia.titulo|urlencode }}%20{{ request.build_absolute_uri }}" target="_blank" rel="noopener" class="share-btn" aria-label="WhatsApp">
        <img src="{% static 'noticias/img/whatsapp.svg' %}" alt="WhatsApp">
      </a>
      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}" target="_blank" rel="noopener" class="share-btn" aria-label="Facebook">
        <img src="{% static 'noticias/img/facebook.svg' %}" alt="Facebook">
      </a>
      <a href="https://www.instagram.com/" target="_blank" rel="noopener" class="share-btn" aria-label="Instagram">
        <img src="{% static 'noticias/img/instagram.svg' %}" alt="Instagram">
      </a>
      <button type="button" class="share-btn" id="copyLink" title="Copiar link" aria-label="Copiar link">
        <img src="{% static 'noticias/img/share.svg' %}" alt="Copiar link">
      </button>
    </div>

    {% if noticia.pk %}
    <form method="post" action="{% url 'noticias:toggle_salvo' noticia.pk %}">
      {% csrf_token %}
      <button
        class="save-main salvar-btn{% if is_saved %} is-saved{% endif %}"
        type="submit"
        aria-pressed="{{ is_saved|yesno:'true,false' }}"
        aria-label="{% if is_saved %}Remover dos salvos{% else %}Salvar para ler mais tarde{% endif %}"
        data-url="{% url 'noticias:toggle_salvo' noticia.pk %}"
        data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
        data-login-url="{% url 'login' %}?next={{ request.path }}">
        <svg viewBox="0 0 24 24" class="save-ico">
          <path d="M6 2h12a 2 2 0 0 1 2 2v18l-8-4-8 4V4a 2 2 0 0 1 2-2z"/>
        </svg>
        <span>{% if is_saved %}Salvo{% else %}Salvar{% endif %}</span>
      </button>
    </form>
    {% endif %}
  </section>

  <!-- ===== TAGS / ASSUNTOS ===== -->
  {% with noticia.assuntos.all as tags %}
  {% if tags %}
  <section class="art-tags">
    <h3 class="tags-title">Tags</h3>
    <div class="tags-wrap">
      {% for tag in tags %}
        <span class="tag-chip">{{ tag.nome|upper }}</span>
      {% endfor %}
    </div>
  </section>
  {% endif %}
  {% endwith %}

</article>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'noticias/js/salvar.js' %}"></script>
<script src="{% static 'noticias/js/resumo.js' %}"></script>
<script>
  // SHARE NATIVO / COPIAR LINK
  (function () {
    var btn = document.getElementById('shareBtn');
    if (btn) {
      btn.addEventListener('click', async function () {
        const data = {
          title: document.title,
          text: "{{ noticia.titulo|escapejs }}",
          url: window.location.href
        };
        if (navigator.share) {
          try { await navigator.share(data); } catch (e) {}
        } else {
          try { await navigator.clipboard.writeText(data.url); } catch (e) {}
        }
      });
    }

    var copyBtn = document.getElementById("copyLink");
    if (copyBtn) {
      copyBtn.addEventListener("click", async function () {
        try {
          await navigator.clipboard.writeText(window.location.href);
          alert("Link copiado!");
        } catch (e) {}
      });
    }
  })();

  // DESABILITAR BOTÃO DA ENQUETE ENQUANTO ENVIA
  (function () {
    const form = document.querySelector('.enquete-form');
    if (!form) {
      return;
    }
    form.addEventListener('submit', function () {
      const btn = form.querySelector('.enquete-btn');
      if (btn) {
        btn.setAttribute('disabled', 'disabled');
        btn.textContent = 'Votando...';
      }
    });
  })();

  // ==============================
  //  CONTINUAR LENDO (DETALHE)
  // ==============================
  (function () {
    const wrapper = document.getElementById('artBodyWrapper');
    const body    = document.getElementById('artBody');
    const btn     = document.getElementById('readMoreBtn');

    if (!wrapper || !body || !btn) {
      return;
    }

    const CLAMP_HEIGHT = 260; // px
    const fullHeight = body.offsetHeight;

    if (fullHeight <= CLAMP_HEIGHT + 10) {
      btn.style.display = 'none';
      wrapper.classList.remove('is-clamped');
      return;
    }

    wrapper.classList.add('is-clamped');
    btn.style.display = 'flex';

    const label = btn.querySelector('.read-more-label');
    let expanded = false;

    btn.addEventListener('click', function () {
      expanded = !expanded;

      if (expanded) {
        wrapper.classList.remove('is-clamped');
        btn.classList.add('is-expanded');
        if (label) {
          label.textContent = 'Mostrar menos';
        }
      } else {
        wrapper.classList.add('is-clamped');
        btn.classList.remove('is-expanded');
        if (label) {
          label.textContent = 'Continuar Lendo';
        }

        window.scrollTo({
          top: wrapper.offsetTop - 120,
          behavior: 'smooth'
        });
      }
    });
  })();
</script>
{% endblock %}