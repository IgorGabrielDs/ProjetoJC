{% extends "base.html" %}
{% load static %}

{% block title %}{{ noticia.titulo }} — JC{% endblock %}

{% block extra_css %}
{{ block.super }}
<link rel="stylesheet" href="{% static 'noticias/css/article.css' %}">
{% endblock %}

{% block content %}
<article class="art-wrap" itemscope itemtype="https://schema.org/NewsArticle">

  <!-- Kicker + ações (topo, linha única) + título -->
  <header class="art-top">
    <div class="art-topbar">
      <div class="art-kicker">
        {% if noticia.assuntos.first %}
          <span class="kicker-link">{{ noticia.assuntos.first.nome }}</span>
        {% endif %}
        <span class="kicker-sep">|</span>
        <span class="kicker-type">NOTÍCIA</span>
      </div>

      <div class="art-actions">
        {% if noticia.pk %}
        <button
          class="salvar-btn salvar-outline card-hero-fav{% if is_saved %} is-saved{% endif %}"
          type="button"
          aria-label="{% if is_saved %}Retirar dos salvos{% else %}Salvar nos favoritos{% endif %}"
          aria-pressed="{{ is_saved|yesno:'true,false' }}"
          data-url="{% url 'noticias:toggle_salvo' noticia.pk %}"
          data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
          data-login-url="{% url 'login' %}?next={{ request.path }}"
        >
          <span class="bm-icon bm-outline" aria-hidden="true">☆</span>
          <span class="bm-icon bm-solid" aria-hidden="true">★</span>
          <span class="sr-only">Salvar esta notícia</span>
        </button>
        {% endif %}

        <!-- COMPARTILHAR -->
        <button class="btn-icon btn-share"
                type="button"
                title="Compartilhar"
                id="shareBtn"
                aria-label="Compartilhar">
          <img src="{% static 'noticias/img/ico-share.png' %}"
               alt="Compartilhar"
               class="share-top-icon">
        </button>
      </div>
    </div>

    <h1 class="art-title" itemprop="headline">{{ noticia.titulo }}</h1>
  </header>

  <!-- Imagem principal (hero) -->
  {% if noticia.imagem %}
  <figure class="art-hero" itemprop="image" itemscope itemtype="https://schema.org/ImageObject">
    {% if noticia.legenda %}
      <img src="{{ noticia.imagem.url }}" alt="{{ noticia.legenda }}" class="hero-img">
    {% else %}
      <img src="{{ noticia.imagem.url }}" alt="Imagem de {{ noticia.titulo }}" class="hero-img">
    {% endif %}
    {% if noticia.legenda or noticia.credito_imagem %}
    <figcaption class="hero-cap">
      <span class="cap-txt">{{ noticia.legenda }}</span>
      {% if noticia.credito_imagem %}
        <span class="cap-credit"> — {{ noticia.credito_imagem }}</span>
      {% endif %}
    </figcaption>
    {% endif %}
    <meta itemprop="url" content="{{ noticia.imagem.url }}">
  </figure>
  {% endif %}

  <!-- Linha de data/atualização/autor -->
  <div class="art-times">
    <time itemprop="datePublished" datetime="{{ noticia.criado_em|date:'c' }}">
      Publicado em {{ noticia.criado_em|date:"d/m/Y" }} às {{ noticia.criado_em|date:"H:i" }}
    </time>
    {% if noticia.atualizado_em and noticia.atualizado_em > noticia.criado_em %}
      <span class="sep">|</span>
      <time itemprop="dateModified" datetime="{{ noticia.atualizado_em|date:'c' }}">
        Atualizado em {{ noticia.atualizado_em|date:"d/m/Y" }} às {{ noticia.atualizado_em|date:"H:i" }}
      </time>
    {% endif %}
    <span class="sep">|</span>
    <span class="byline">
      Por: <span class="who" itemprop="author" itemscope itemtype="https://schema.org/Organization">
        <span itemprop="name">{{ noticia.autor|default:"JC" }}</span>
      </span>
    </span>
  </div>

  {# ============================= #}
  {# BLOCO DE RESUMO (texto azul antes da matéria) #}
  {% if resumo_text %}
    <meta itemprop="description" content="{{ resumo_text|striptags|truncatechars:280 }}">
    <section class="art-lead-box" aria-label="Resumo da notícia">
      <p class="art-lead-text">
        {{ resumo_text|linebreaksbr }}
      </p>
    </section>
  {% endif %}

  {# ============================= #}
  {# TEXTO DA NOTÍCIA + CONTINUAR LENDO #}
  <section class="art-content-block">
    <div class="art-body-wrapper" id="artBodyWrapper">
      <div class="art-body" id="artBody" itemprop="articleBody">
        {{ noticia.conteudo|linebreaks }}
      </div>
    </div>

    <button type="button" class="read-more-btn" id="readMoreBtn">
      <span class="read-more-label">Continuar Lendo</span>
      <span class="read-more-chevron" aria-hidden="true"></span>
    </button>
  </section>

  <!-- ============================= -->
  <!-- ===== BLOCO DA ENQUETE ===== -->
  {% if enquete_data %}
  <section class="enquete-box" aria-labelledby="enquete-titulo-{{ enquete_data.obj.pk }}">
    <h2 class="enquete-titulo" id="enquete-titulo-{{ enquete_data.obj.pk }}">
      {{ enquete_data.obj.titulo }}
    </h2>

    {% if user.is_authenticated %}

      {% if enquete_data.usuario_ja_votou %}
        <div class="enquete-resultados">
          {% for op in enquete_data.opcoes %}
            <div class="enquete-opcao-resultado {% if op.id == enquete_data.voto_usuario_id %}enquete-voto-usuario{% endif %}">
              <div class="info-wrapper">
                <span class="texto-opcao">{{ op.texto }}</span>
                <span class="percentual">{{ op.percentual }}%</span>
              </div>
              <div class="enquete-barra">
                <div class="enquete-barra-preenchimento" style="width: {{ op.percentual }}%;"></div>
              </div>
            </div>
          {% endfor %}
          <span class="enquete-total-votos">Total de {{ enquete_data.total_votos }} votos.</span>
        </div>
      {% else %}
        <form class="enquete-form" method="POST" action="{% url 'noticias:votar_enquete' enquete_data.obj.pk %}">
          {% csrf_token %}
          <fieldset>
            <legend class="sr-only">Opções da enquete</legend>
            {% for op in enquete_data.opcoes %}
              <div class="enquete-opcao-radio">
                <input type="radio" name="opcao_enquete" value="{{ op.id }}" id="op-{{ op.id }}" required>
                <label for="op-{{ op.id }}">{{ op.texto }}</label>
              </div>
            {% empty %}
              <p>Não há opções nesta enquete no momento.</p>
            {% endfor %}
          </fieldset>
          {% if enquete_data.opcoes %}
            <button class="enquete-btn" type="submit">Votar</button>
          {% endif %}
        </form>
      {% endif %}

    {% else %}
      <div class="enquete-resultados">
        {% for op in enquete_data.opcoes %}
          <div class="enquete-opcao-resultado">
            <div class="info-wrapper">
              <span class="texto-opcao">{{ op.texto }}</span>
              <span class="percentual">{{ op.percentual }}%</span>
            </div>
            <div class="enquete-barra">
              <div class="enquete-barra-preenchimento" style="width: {{ op.percentual }}%;"></div>
            </div>
          </div>
        {% endfor %}
      </div>

      <p class="enquete-login-aviso">
        <a href="{% url 'login' %}?next={{ request.path }}">Faça login</a> para votar nesta enquete.
      </p>
      <span class="enquete-total-votos">Total de {{ enquete_data.total_votos }} votos.</span>
    {% endif %}
  </section>
  {% endif %}
  <!-- ===== FIM DA ENQUETE ===== -->

  <!-- ===== LEIA TAMBÉM ===== -->
  {% if relacionadas %}
  <section class="art-related">
    <h2 class="related-title">LEIA TAMBÉM</h2>
    <div class="related-grid">
      {% for rel in relacionadas %}
      <a href="{% url 'noticias:noticia_detalhe' rel.pk %}" class="related-card">
        {% if rel.imagem %}
          {% if rel.legenda %}
            <img src="{{ rel.imagem.url }}" alt="{{ rel.legenda }}" class="related-img">
          {% else %}
            <img src="{{ rel.imagem.url }}" alt="{{ rel.titulo }}" class="related-img">
          {% endif %}
        {% endif %}
        <div class="related-info">
          {% if rel.assuntos.first %}
            <p class="related-cat">{{ rel.assuntos.first.nome|upper }}</p>
          {% endif %}
          <h3 class="related-head">{{ rel.titulo }}</h3>
          <p class="related-desc">
            {{ rel.resumo|default:rel.conteudo|default:rel.titulo|truncatewords:22 }}
          </p>
        </div>
      </a>
      {% endfor %}
    </div>
  </section>
  {% endif %}

  <!-- ===== COMPARTILHE ===== -->
  <section class="art-share" aria-labelledby="share-heading">
    <h2 class="share-title" id="share-heading">
      <span class="share-title-text">Compartilhe</span>
      <span class="share-title-colon">:</span>
    </h2>

    <div class="share-icons" role="list">
      <a href="https://api.whatsapp.com/send?text={{ noticia.titulo|urlencode }}%20{{ request.build_absolute_uri }}"
         target="_blank"
         rel="noopener"
         class="share-btn share-btn-square"
         aria-label="WhatsApp"
         role="listitem">
        <img src="https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/whatsapp.svg" alt="WhatsApp">
      </a>

      <a href="https://www.facebook.com/sharer/sharer.php?u={{ request.build_absolute_uri }}"
         target="_blank"
         rel="noopener"
         class="share-btn share-btn-square"
         aria-label="Facebook"
         role="listitem">
        <img src="https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/facebook.svg" alt="Facebook">
      </a>

      <a href="https://www.instagram.com/"
         target="_blank"
         rel="noopener"
         class="share-btn share-btn-square"
         aria-label="Instagram"
         role="listitem">
        <img src="https://cdn.jsdelivr.net/npm/simple-icons@v11/icons/instagram.svg" alt="Instagram">
      </a>

      <button type="button"
              class="share-btn share-btn-square"
              id="copyLink"
              title="Copiar link"
              aria-label="Copiar link"
              role="listitem">
        <img src="https://cdn-icons-png.flaticon.com/512/1828/1828919.png" alt="Copiar link">
      </button>
    </div>
  </section>

  <!-- ===== TAGS / ASSUNTOS ===== -->
  {% with noticia.assuntos.all as tags %}
  {% if tags %}
  <section class="art-tags" aria-labelledby="tags-heading">
    <div class="tags-header">
      <h2 class="tags-title" id="tags-heading">
        <span class="tags-title-text">Tags</span>
        <span class="tags-title-colon">:</span>
      </h2>
    </div>

    <div class="tags-wrap tags-chips" role="list">
      {% for tag in tags %}
        <span class="tag-chip" role="listitem">
          {{ tag.nome|upper }}
        </span>
      {% endfor %}
    </div>
  </section>
  {% endif %}
  {% endwith %}

</article>

{# ============================= #}
{# PUBLICIDADE LEGAL NO DETALHE #}
{% if publicidade_legal %}
<section class="publicidade-legal" aria-labelledby="publicidade-legal-title">
  <header class="publicidade-legal-header">
    <span class="publicidade-legal-rule" aria-hidden="true"></span>
    <h2 id="publicidade-legal-title" class="publicidade-legal-title">
      Publicidade legal
    </h2>
    <span class="publicidade-legal-rule" aria-hidden="true"></span>
  </header>

  <div class="publicidade-legal-grid">
    {% for item in publicidade_legal|slice:":2" %}
      <article class="publicidade-legal-card">
        <div class="publicidade-legal-card-header">
          <span class="publicidade-legal-tag">
            {% if item.assuntos.first %}
              {{ item.assuntos.first.nome|upper }}
            {% else %}
              PUBLICIDADE
            {% endif %}
          </span>

          <button
            type="button"
            class="publicidade-legal-fav salvar-btn {% if item in salvos %}is-saved{% endif %}"
            data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
            data-url="{% url 'noticias:toggle_salvo' item.pk %}"
            data-login-url="{% url 'login' %}?next={{ request.path }}"
            aria-pressed="{% if item in salvos %}true{% else %}false{% endif %}"
          >
            <span class="bm-icon bm-outline" aria-hidden="true">☆</span>
            <span class="bm-icon bm-solid" aria-hidden="true">★</span>
            <span class="sr-only">Salvar esta notícia</span>
          </button>
        </div>

        <a href="{{ item.get_absolute_url }}" class="publicidade-legal-link">
          <div class="publicidade-legal-media">
            {% if item.imagem %}
              <img src="{{ item.imagem.url }}" alt="{{ item.titulo }}">
            {% else %}
              <div class="publicidade-thumb-placeholder" aria-hidden="true"></div>
            {% endif %}
          </div>

          <p class="publicidade-legal-text">
            {{ item.resumo|default:item.titulo }}
          </p>
        </a>
      </article>
    {% endfor %}
  </div>

  {% if publicidade_legal|length > 2 %}
    <div class="publicidade-legal-more">
      <button type="button" class="publicidade-legal-more-btn">
        Ver mais
      </button>
    </div>
  {% endif %}
</section>
{% endif %}

<section class="section para-voce-section">
  <div class="container">

    <!-- Título com linhas laterais -->
    <div class="section-title pv-title">
      <span class="rule"></span>
      <span class="label">Para você</span>
      <span class="rule"></span>
    </div>

    {% with pv_list=pv|default:para_voce %}
    {% if pv_list %}

      <!-- Carrossel 2x2 -->
      <div class="carousel para-voce-carousel">
        <input type="radio" name="pv" id="pv1" checked>
        <input type="radio" name="pv" id="pv2">
        <input type="radio" name="pv" id="pv3">

        <div class="carousel-inner">
          <div class="carousel-track">

            <!-- Slide 1 -->
            <div class="carousel-slide">
              <div class="para-voce-grid">
                {% for item in pv_list|slice:":2" %}
                <article class="para-voce-card" data-href="{{ item.get_absolute_url }}">
                  <a href="{{ item.get_absolute_url }}" class="para-voce-link">

                    {% if item.assuntos.first %}
                    <!-- HEADER DO CARD: ASSUNTO + ESTRELA -->
                    <div class="pv-card-header">
                      <span class="pv-tag-label">
                        {{ item.assuntos.first.nome|upper }}
                      </span>

                      <button
                        class="card-hero-fav bookmark-btn salvar-btn{% if item.is_saved %} is-saved{% endif %}"
                        aria-label="{% if item.is_saved %}Retirar dos salvos{% else %}Salvar nos favoritos{% endif %}"
                        aria-pressed="{{ item.is_saved|yesno:'true,false' }}"
                        data-url="{% url 'noticias:toggle_salvo' item.pk %}"
                        data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
                        data-login-url="{% url 'login' %}?next={{ item.get_absolute_url }}">
                        <span class="bm-icon bm-outline">☆</span>
                        <span class="bm-icon bm-solid">★</span>
                      </button>
                    </div>
                    {% endif %}

                    <div class="para-voce-thumb">
                      {% if item.imagem %}
                        <img src="{{ item.imagem.url }}"
                             alt="{{ item.alt_imagem|default:item.titulo }}">
                      {% endif %}
                    </div>

                    <p class="para-voce-text">
                      {{ item.titulo }}
                    </p>
                  </a>
                </article>
                {% endfor %}
              </div>
            </div>

            {% if pv_list|length > 2 %}
            <!-- Slide 2 -->
            <div class="carousel-slide">
              <div class="para-voce-grid">
                {% for item in pv_list|slice:"2:4" %}
                <article class="para-voce-card" data-href="{{ item.get_absolute_url }}">
                  <a href="{{ item.get_absolute_url }}" class="para-voce-link">

                    {% if item.assuntos.first %}
                    <div class="pv-card-header">
                      <span class="pv-tag-label">
                        {{ item.assuntos.first.nome|upper }}
                      </span>

                      <button
                        class="card-hero-fav bookmark-btn salvar-btn{% if item.is_saved %} is-saved{% endif %}"
                        aria-label="{% if item.is_saved %}Retirar dos salvos{% else %}Salvar nos favoritos{% endif %}"
                        aria-pressed="{{ item.is_saved|yesno:'true,false' }}"
                        data-url="{% url 'noticias:toggle_salvo' item.pk %}"
                        data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
                        data-login-url="{% url 'login' %}?next={{ item.get_absolute_url }}">
                        <span class="bm-icon bm-outline">☆</span>
                        <span class="bm-icon bm-solid">★</span>
                      </button>
                    </div>
                    {% endif %}

                    <div class="para-voce-thumb">
                      {% if item.imagem %}
                        <img src="{{ item.imagem.url }}"
                             alt="{{ item.alt_imagem|default:item.titulo }}">
                      {% endif %}
                    </div>

                    <p class="para-voce-text">
                      {{ item.titulo }}
                    </p>
                  </a>
                </article>
                {% endfor %}
              </div>
            </div>
            {% endif %}

            {% if pv_list|length > 4 %}
            <!-- Slide 3 -->
            <div class="carousel-slide">
              <div class="para-voce-grid">
                {% for item in pv_list|slice:"4:6" %}
                <article class="para-voce-card" data-href="{{ item.get_absolute_url }}">
                  <a href="{{ item.get_absolute_url }}" class="para-voce-link">

                    {% if item.assuntos.first %}
                    <div class="pv-card-header">
                      <span class="pv-tag-label">
                        {{ item.assuntos.first.nome|upper }}
                      </span>

                      <button
                        class="card-hero-fav bookmark-btn salvar-btn{% if item.is_saved %} is-saved{% endif %}"
                        aria-label="{% if item.is_saved %}Retirar dos salvos{% else %}Salvar nos favoritos{% endif %}"
                        aria-pressed="{{ item.is_saved|yesno:'true,false' }}"
                        data-url="{% url 'noticias:toggle_salvo' item.pk %}"
                        data-auth="{{ user.is_authenticated|yesno:'1,0' }}"
                        data-login-url="{% url 'login' %}?next={{ item.get_absolute_url }}">
                        <span class="bm-icon bm-outline">☆</span>
                        <span class="bm-icon bm-solid">★</span>
                      </button>
                    </div>
                    {% endif %}

                    <div class="para-voce-thumb">
                      {% if item.imagem %}
                        <img src="{{ item.imagem.url }}"
                             alt="{{ item.alt_imagem|default:item.titulo }}">
                      {% endif %}
                    </div>

                    <p class="para-voce-text">
                      {{ item.titulo }}
                    </p>
                  </a>
                </article>
                {% endfor %}
              </div>
            </div>
            {% endif %}

          </div>
        </div>

        <!-- Dots -->
        <div class="dots pv-dots" aria-label="Paginação do carrossel">
          <label for="pv1" class="dot d1"></label>
          <label for="pv2" class="dot d2"></label>
          <label for="pv3" class="dot d3"></label>
        </div>
      </div>
    {% endif %}
    {% endwith %}
  </div>
</section>

<section class="escute-agora-section" aria-label="Escute agora">
  <div class="escute-agora-header">
    <span class="escute-agora-rule"></span>
    <h2 class="escute-agora-title">Escute agora</h2>
    <span class="escute-agora-rule"></span>
  </div>

  <!-- Bloco Rádio Jornal (3 cards em linha) -->
  <div class="escute-bloco escute-bloco--radio">
    <span class="escute-pill">Rádio Jornal</span>

    <div class="escute-canais-lista escute-canais-lista--scroll">
      <a href="#" class="escute-card">
        <div class="escute-card-icone">
          <div class="escute-wave" aria-hidden="true"></div>
        </div>
        <p class="escute-card-label">Recife</p>
      </a>

      <a href="#" class="escute-card">
        <div class="escute-card-icone">
          <div class="escute-wave" aria-hidden="true"></div>
        </div>
        <p class="escute-card-label">Interior</p>
      </a>

      <a href="#" class="escute-card">
        <div class="escute-card-icone">
          <div class="escute-wave" aria-hidden="true"></div>
        </div>
        <p class="escute-card-label">Interior</p>
      </a>
    </div>
  </div>

  <!-- Dots entre Rádio e TV -->
  <div class="escute-dots" aria-hidden="true">
    <span class="escute-dot escute-dot--active"></span>
    <span class="escute-dot"></span>
    <span class="escute-dot"></span>
  </div>

  <!-- Bloco TV Jornal (2 cards lado a lado) -->
  <div class="escute-bloco escute-bloco--tv">
    <span class="escute-pill">TV Jornal</span>

    <div class="escute-canais-lista escute-canais-lista--grid">
      <a href="#" class="escute-card">
        <div class="escute-card-icone">
          <div class="escute-wave" aria-hidden="true"></div>
        </div>
        <p class="escute-card-label">Recife</p>
      </a>

      <a href="#" class="escute-card">
        <div class="escute-card-icone">
          <div class="escute-wave" aria-hidden="true"></div>
        </div>
        <p class="escute-card-label">Interior</p>
      </a>
    </div>
  </div>
</section>

{% endblock %}

{% block extra_js %}
{{ block.super }}
<script src="{% static 'noticias/js/salvar.js' %}"></script>
<script>
  // SHARE NATIVO / COPIAR LINK
  (function () {
    var btn = document.getElementById('shareBtn');
    if (btn) {
      btn.addEventListener('click', async function () {
        const data = {
          title: document.title,
          text: "{{ noticia.titulo|escapejs }}",
          url: window.location.href
        };
        if (navigator.share) {
          try { await navigator.share(data); } catch (e) {}
        } else {
          try { await navigator.clipboard.writeText(data.url); } catch (e) {}
        }
      });
    }

    var copyBtn = document.getElementById("copyLink");
    if (copyBtn) {
      copyBtn.addEventListener("click", async function () {
        try {
          await navigator.clipboard.writeText(window.location.href);
          alert("Link copiado!");
        } catch (e) {}
      });
    }
  })();

  // DESABILITAR BOTÃO DA ENQUETE ENQUANTO ENVIA
  (function () {
    const form = document.querySelector('.enquete-form');
    if (!form) {
      return;
    }
    form.addEventListener('submit', function () {
      const btn = form.querySelector('.enquete-btn');
      if (btn) {
        btn.setAttribute('disabled', 'disabled');
        btn.textContent = 'Votando...';
      }
    });
  })();

  // CONTINUAR LENDO
  (function () {
    const wrapper = document.getElementById('artBodyWrapper');
    const body    = document.getElementById('artBody');
    const btn     = document.getElementById('readMoreBtn');

    if (!wrapper || !body || !btn) {
      return;
    }

    const CLAMP_HEIGHT = 260; // px
    const fullHeight = body.offsetHeight;

    if (fullHeight <= CLAMP_HEIGHT + 10) {
      btn.style.display = 'none';
      wrapper.classList.remove('is-clamped');
      return;
    }

    wrapper.classList.add('is-clamped');
    btn.style.display = 'flex';

    const label = btn.querySelector('.read-more-label');
    let expanded = false;

    btn.addEventListener('click', function () {
      expanded = !expanded;

      if (expanded) {
        wrapper.classList.remove('is-clamped');
        btn.classList.add('is-expanded');
        if (label) {
          label.textContent = 'Mostrar menos';
        }
      } else {
        wrapper.classList.add('is-clamped');
        btn.classList.remove('is-expanded');
        if (label) {
          label.textContent = 'Continuar Lendo';
        }

        window.scrollTo({
          top: wrapper.offsetTop - 120,
          behavior: 'smooth'
        });
      }
    });
  })();
</script>
{% endblock %}
