{% extends 'base.html' %}
{% load static %}

{% block title %}Ca√ßa Links - {{ tema.nome }}{% endblock %}

{% block extra_head %}
<style>
/* base */
body { background: #f0f2f5; font-family: Arial, sans-serif; }

.caca-container {
    max-width: 520px;
    margin: 20px auto;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    overflow: hidden;
}

/* header */
.header-controls {
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 16px; border-bottom:1px solid #ddd;
}
.header-left { display:flex; align-items:center; gap:10px; }
.header-logo { width:40px; }
#timer { font-weight:bold; }
.pause-btn, .check-btn {
    background:#000; color:#fff; padding:6px 12px; border:none; border-radius:6px; cursor:pointer;
}
.pause-btn:hover, .check-btn:hover { background:#333; }

/* grid */
#caca-grid { display:grid; margin:15px; border:1px solid #ddd; background:#fff; }
.caca-cell { display:flex; justify-content:center; align-items:center; border:1px solid #eee; font-weight:bold; cursor:pointer; user-select:none; aspect-ratio:1/1; text-transform:uppercase; color:#333; }
.caca-cell.selected { background:#e3f2fd; color:#007bff; }
.caca-cell.found { background:#d4edda; color:#28a745; }

/* texto */
.text-section { padding:15px; line-height:1.5; color:#444; }
.highlight-word { color:#007bff; font-weight:bold; text-decoration:underline; cursor:help; }
.highlight-word.found-text { color:#28a745; text-decoration:line-through; }

/* modal */
.modal-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.6); display:none; align-items:center; justify-content:center; z-index:5000; }
.modal-overlay.active { display:flex; }
.modal-content { background:#fff; padding:24px; border-radius:12px; width:90%; max-width:420px; text-align:center; box-shadow:0 4px 15px rgba(0,0,0,0.15); }
.win-btn { background:#D90429; color:#fff; border:none; padding:10px 16px; border-radius:8px; cursor:pointer; font-weight:bold; margin:8px; }

/* pause overlay */
#pause-overlay { position:fixed; inset:0; background:rgba(0,0,0,0.8); color:#fff; font-size:2rem; display:none; align-items:center; justify-content:center; z-index:4000; }
#pause-overlay.active { display:flex; }
</style>
{% endblock %}

{% block content %}
<div class="caca-container">
    <div class="header-controls">
        <div class="header-left">
            <img src="{% static 'caca_links/img/logo-jcpe.png' %}" class="header-logo" alt="logo">
            <span id="timer">00:00</span>
            <button id="pause-btn" class="pause-btn">‚è∏Ô∏è Pausar</button>
            <button id="check-btn" class="check-btn">‚úî Conferir</button>
        </div>

        <input id="search" style="padding:6px;border:1px solid #ccc;border-radius:6px;" placeholder="Buscar palavras">
    </div>

    <div id="caca-grid" aria-hidden="false"></div>

    <div class="text-section" id="texto-formatado">
        {% autoescape off %}
            {{ texto_da_noticia_formatado }}
        {% endautoescape %}
    </div>
</div>

<!-- sucesso -->
<div id="win-modal" class="modal-overlay" role="dialog" aria-modal="true">
    <div class="modal-content">
        <h2>üéâ Parab√©ns!</h2>
        <p>Voc√™ encontrou todas as palavras!</p>
        <div>
            <button id="go-news" class="win-btn">üì∞ Ver not√≠cia</button>
            <button id="next-level" class="win-btn">‚û° Pr√≥ximo n√≠vel</button>
        </div>
    </div>
</div>

<div id="pause-overlay">‚è∏Ô∏è Jogo Pausado</div>

{{ caca.grade|json_script:"grid-data" }}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    /* ===== TIMER ===== */
    let paused = false;
    const timerEl = document.getElementById("timer");
    const start = Date.now();
    setInterval(() => {
        if (!paused) {
            const t = Math.floor((Date.now() - start) / 1000);
            const m = String(Math.floor(t/60)).padStart(2,'0');
            const s = String(t%60).padStart(2,'0');
            timerEl.textContent = `${m}:${s}`;
        }
    }, 1000);

    /* ===== PAUSE ===== */
    const pauseBtn = document.getElementById("pause-btn");
    const pauseOverlay = document.getElementById("pause-overlay");
    pauseBtn.addEventListener("click", () => {
        paused = !paused;
        pauseBtn.textContent = paused ? "‚ñ∂Ô∏è Retomar" : "‚è∏Ô∏è Pausar";
        pauseOverlay.classList.toggle("active", paused);
        document.getElementById("caca-grid").style.pointerEvents = paused ? "none" : "auto";
    });

    /* ===== GRID RENDER ===== */
    const gridScript = document.getElementById("grid-data");
    if (!gridScript) return; // nada a renderizar
    const gridData = JSON.parse(gridScript.textContent);
    const gridEl = document.getElementById("caca-grid");
    const size = gridData.length;
    gridEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;

    // cria c√©lulas
    for (let r=0; r<size; r++){
        for (let c=0; c<size; c++){
            const cell = document.createElement("div");
            cell.className = "caca-cell";
            cell.textContent = gridData[r][c];
            cell.dataset.r = r;
            cell.dataset.c = c;
            gridEl.appendChild(cell);
        }
    }

    /* ===== PALAVRAS DO TEXTO ===== */
    const textoEl = document.getElementById("texto-formatado");
    const highlighted = Array.from(textoEl.querySelectorAll(".highlight-word")).map(e => e.dataset.word);

    /* ===== SELE√á√ÉO POR CLIQUE + DRAG (linhas retas) ===== */
    let selecting = false;
    let selection = [];
    let startCell = null;
    let direction = null;

    function posOf(cell){
        return { r: +cell.dataset.r, c: +cell.dataset.c };
    }
    function decideDirection(s, cur){
        const dr = cur.r - s.r;
        const dc = cur.c - s.c;
        if (dr === 0 && dc !== 0) return 'H';
        if (dc === 0 && dr !== 0) return 'V';
        if (Math.abs(dr) === Math.abs(dc)) return 'D';
        return null;
    }
    // toggle por clique
    gridEl.addEventListener("click", e => {
        const t = e.target;
        if (!t.classList.contains("caca-cell") || paused) return;
        if (t.classList.contains("found")) return; // encontrada permanece
        if (t.classList.contains("selected")) {
            t.classList.remove("selected");
            selection = selection.filter(x => x !== t);
        } else {
            t.classList.add("selected");
            selection.push(t);
        }
    });

    // drag start
    gridEl.addEventListener("mousedown", e => {
        const t = e.target;
        if (!t.classList.contains("caca-cell") || paused) return;
        selecting = true;
        selection = [t];
        startCell = t;
        direction = null;
        if (!t.classList.contains("found")) t.classList.add("selected");
    });

    // drag over
    gridEl.addEventListener("mouseover", e => {
        if (!selecting || paused) return;
        const t = e.target;
        if (!t.classList.contains("caca-cell")) return;
        if (t.classList.contains("found")) return;
        if (selection.includes(t)) return; // n√£o re-adiciona
        const sPos = posOf(startCell);
        const curPos = posOf(t);
        if (!direction) {
            direction = decideDirection(sPos, curPos);
            if (!direction) return;
        }
        // garante que a c√©lula atual esteja na mesma dire√ß√£o
        if (decideDirection(sPos, curPos) !== direction) return;
        // adiciona linha reta (adiciona c√©lulas intermedi√°rias)
        const last = selection[selection.length - 1];
        // adiciona t direto (aceitamos apenas linha reta)
        selection.push(t);
        t.classList.add("selected");
    });

    // drag release
    document.addEventListener("mouseup", () => {
        selecting = false;
        startCell = null;
        direction = null;
        // NOTA: a valida√ß√£o s√≥ acontece quando usu√°rio clicar em "Conferir"
    });

    /* ===== CONFIRMAR PALAVRA (bot√£o) ===== */
    const checkBtn = document.getElementById("check-btn");
    checkBtn.addEventListener("click", () => {
        if (selection.length === 0) return;

        const word = selection.map(c => c.textContent).join('');
        const rev = word.split('').reverse().join('');

        let found = null;
        for (const p of highlighted) {
            if (p === word || p === rev) { found = p; break; }
        }

        if (found) {
            // marca como encontrada
            selection.forEach(c => { c.classList.remove("selected"); c.classList.add("found"); });
            document.querySelectorAll(".highlight-word").forEach(el => {
                if (el.dataset.word === found) el.classList.add("found-text");
            });
        } else {
            // limpa sele√ß√£o (volta ao normal)
            selection.forEach(c => c.classList.remove("selected"));
        }

        // zera sele√ß√£o
        selection = [];

        // verifica vit√≥ria
        if (document.querySelectorAll(".highlight-word:not(.found-text)").length === 0) {
            document.getElementById("win-modal").classList.add("active");
        }
    });

    /* ===== BOT√ïES DO MODAL ===== */
    document.getElementById("go-news").addEventListener("click", () => {
        window.location.href = "{{ caca.noticia.get_absolute_url }}";
    });
    document.getElementById("next-level").addEventListener("click", () => {
        // redireciona para mesmo tema com nivel+1
        window.location.href = "{% url 'caca_links:jogar' tema.id %}?nivel={{ nivel|add:1 }}";
    });

});
</script>
{% endblock %}
