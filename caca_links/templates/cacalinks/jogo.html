{% extends 'base.html' %}
{% load static %}

{% block title %}Ca√ßa Links - {{ tema.nome }}{% endblock %}

{% block extra_head %}
<style>
body { background: #f0f2f5; }

.caca-container {
    max-width: 520px;
    margin: 20px auto;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    overflow: hidden;
}

/* HEADER */
.header-controls {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 12px 16px;
    border-bottom: 1px solid #ddd;
}
.header-left { display: flex; align-items: center; gap: 10px; }
.header-logo { width: 40px; }
.timer { font-weight: bold; }

.pause-btn, .check-btn {
    background: #000;
    color: #fff;
    padding: 6px 12px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
}
.pause-btn:hover, .check-btn:hover { background: #333; }

/* GRID */
#caca-grid {
    display: grid;
    margin: 15px;
    border: 1px solid #ddd;
}
.caca-cell {
    display: flex;
    justify-content: center;
    align-items: center;
    border: 1px solid #eee;
    font-weight: bold;
    cursor: pointer;
    user-select: none;
    aspect-ratio: 1 / 1;
}
.caca-cell.selected { background: #e3f2fd; color: #007bff; }
.caca-cell.found { background: #d4edda; color: #28a745; }

/* TEXTO */
.text-section { padding: 15px; line-height: 1.5; }
.highlight-word {
    color: #007bff;
    font-weight: bold;
    text-decoration: underline;
}
.highlight-word.found-text {
    color: #28a745;
    text-decoration: line-through;
}

/* MODAL */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.6);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5000;
}
.modal-overlay.active { display: flex; }

.modal-content {
    background: #fff;
    padding: 25px;
    border-radius: 12px;
    width: 90%;
    max-width: 400px;
    text-align: center;
}
.close-btn {
    background: none;
    border: none;
    font-size: 1.4rem;
    position: absolute;
    right: 12px;
    top: 10px;
    cursor: pointer;
}

/* PAUSA */
#pause-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    font-size: 2rem;
    color: white;
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 4000;
}
#pause-overlay.active { display: flex; }
</style>
{% endblock %}

{% block content %}
<div class="caca-container">

    <div class="header-controls">
        <div class="header-left">
            <img src="{% static 'caca_links/img/logo-jcpe.png' %}" class="header-logo">
            <span id="timer" class="timer">00:00</span>
            <button id="pause-btn" class="pause-btn">‚è∏Ô∏è Pausar</button>
            <button id="check-btn" class="check-btn">‚úî Conferir</button>
        </div>

        <input id="search" style="padding:6px;border:1px solid #ccc;border-radius:6px;" placeholder="Buscar palavras">
    </div>

    <div id="caca-grid"></div>

    <div class="text-section" id="texto-formatado">
        {% autoescape off %}
            {{ texto_da_noticia_formatado }}
        {% endautoescape %}
    </div>

</div>

<!-- MODAL VIT√ìRIA -->
<div id="win-modal" class="modal-overlay">
    <div class="modal-content">
        <button class="close-btn" onclick="document.getElementById('win-modal').classList.remove('active')">√ó</button>
        <h2>üéâ Parab√©ns!</h2>
        <p>Voc√™ encontrou todas as palavras.</p>

        <button onclick="window.location.href='{{ caca.noticia.get_absolute_url }}'" class="pause-btn">üì∞ Ver not√≠cia</button>

        <button onclick="window.location.href='?nivel={{ nivel|add:1 }}'" class="pause-btn">‚û° Pr√≥ximo n√≠vel</button>
    </div>
</div>

<div id="pause-overlay">‚è∏Ô∏è Jogo Pausado</div>

{{ caca.grade|json_script:"grid-data" }}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    /* TIMER */
    let paused = false;
    let start = Date.now();
    setInterval(() => {
        if (!paused) {
            const t = Math.floor((Date.now() - start) / 1000);
            const m = String(Math.floor(t / 60)).padStart(2,'0');
            const s = String(t % 60).padStart(2,'0');
            document.getElementById("timer").textContent = `${m}:${s}`;
        }
    }, 1000);

    /* PAUSE */
    const pauseBtn = document.getElementById("pause-btn");
    const pauseOverlay = document.getElementById("pause-overlay");
    pauseBtn.addEventListener("click", () => {
        paused = !paused;
        pauseBtn.textContent = paused ? "‚ñ∂Ô∏è Retomar" : "‚è∏Ô∏è Pausar";
        pauseOverlay.classList.toggle("active", paused);
    });

    /* GRID */
    const gridData = JSON.parse(document.getElementById("grid-data").textContent);
    const grid = document.getElementById("caca-grid");
    grid.style.gridTemplateColumns = `repeat(${gridData.length}, 1fr)`;

    gridData.forEach((row, r) => {
        row.forEach((letter, c) => {
            const div = document.createElement("div");
            div.className = "caca-cell";
            div.textContent = letter;
            div.dataset.r = r;
            div.dataset.c = c;
            grid.appendChild(div);
        });
    });

    /* PALAVRAS DO TEXTO */
    const texto = document.getElementById("texto-formatado");
    const palavrasMarcadas = Array.from(texto.querySelectorAll(".highlight-word"))
        .map(e => e.dataset.word);

    /* SELE√á√ÉO */
    let selecting = false;
    let selection = [];
    let startCell = null;
    let direction = null;

    const getPos = cell => ({
        r: +cell.dataset.r,
        c: +cell.dataset.c
    });

    const getDirection = (s, c) => {
        const dr = c.r - s.r;
        const dc = c.c - s.c;

        if (dr === 0 && dc !== 0) return "H";
        if (dc === 0 && dr !== 0) return "V";
        if (Math.abs(dr) === Math.abs(dc)) return "D";
        return null;
    };

    /* CLIQUE INDIVIDUAL */
    grid.addEventListener("click", e => {
        if (!e.target.classList.contains("caca-cell")) return;

        if (e.target.classList.contains("selected")) {
            e.target.classList.remove("selected");
            selection = selection.filter(x => x !== e.target);
        } else {
            e.target.classList.add("selected");
            selection.push(e.target);
        }
    });

    /* DRAG */
    grid.addEventListener("mousedown", e => {
        if (!e.target.classList.contains("caca-cell") || paused) return;

        selecting = true;
        selection = [e.target];
        startCell = e.target;
        direction = null;

        e.target.classList.add("selected");
    });

    grid.addEventListener("mouseover", e => {
        if (!selecting || paused) return;
        if (!e.target.classList.contains("caca-cell")) return;

        const last = selection[selection.length - 1];
        if (e.target === last) return;

        const s = getPos(startCell);
        const cur = getPos(e.target);

        if (!direction) {
            direction = getDirection(s, cur);
            if (!direction) return;
        }

        if (getDirection(s, cur) !== direction) return;

        selection.push(e.target);
        e.target.classList.add("selected");
    });

    document.addEventListener("mouseup", () => {
        selecting = false;
        startCell = null;
        direction = null;
    });

    /* BOT√ÉO CONFIRMAR PALAVRA */
    document.getElementById("check-btn").addEventListener("click", () => {

        const word = selection.map(c => c.textContent).join("");
        const rev = [...word].reverse().join("");

        let found = false;

        palavrasMarcadas.forEach(p => {
            if (p === word || p === rev) {
                found = true;

                selection.forEach(c => c.classList.add("found"));
                document.querySelectorAll(".highlight-word").forEach(e => {
                    if (e.dataset.word === p)
                        e.classList.add("found-text");
                });
            }
        });

        if (!found) {
            selection.forEach(c => c.classList.remove("selected"));
        }

        selection = [];

        if (document.querySelectorAll(".highlight-word:not(.found-text)").length === 0) {
            document.getElementById("win-modal").classList.add("active");
        }
    });

});
</script>
{% endblock %}
