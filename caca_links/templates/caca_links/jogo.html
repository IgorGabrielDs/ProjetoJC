{% extends 'base.html' %}
{% load static %}

{% block title %}CaÃ§a Links - {{ tema.nome }}{% endblock %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
<style>
body { background: #f0f2f5; font-family: Arial, sans-serif; }

.caca-container {
    max-width: 520px;
    margin: 20px auto;
    background: #fff;
    border-radius: 10px;
    box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    overflow: hidden;
}

/* header */
.header-controls {
    display:flex; justify-content:space-between; align-items:center;
    padding:12px 16px; border-bottom:1px solid #ddd;
}
.header-left { display:flex; align-items:center; gap:10px; }
.header-logo { width:40px; }
#timer { font-weight:bold; }

/* PAUSE BUTTON */
.pause-square {
    background:white;
    border:2px solid #ccc;
    width:42px; height:42px;
    border-radius:10px;
    display:flex; justify-content:center; align-items:center;
    cursor:pointer;
}
.pause-square img {
    width:22px;
}

/* HEADER ICONS */
.header-icons img {
    width:26px;
    height:26px;
    cursor:pointer;
}

/* GRID */
#caca-grid { display:grid; margin:15px; border:1px solid #ddd; background:#fff; }
.caca-cell { 
    display:flex; justify-content:center; align-items:center; 
    border:1px solid #eee; 
    font-weight:bold; 
    cursor:pointer; 
    user-select:none; 
    aspect-ratio:1/1; 
    text-transform:uppercase; 
    color:#333; 
}
.caca-cell.selected { background:#e3f2fd; color:#007bff; }
.caca-cell.found { background:#d4edda; color:#28a745; }

/* TEXTO */
.text-section { padding:15px; line-height:1.5; color:#444; }
.highlight-word { color:#007bff; font-weight:bold; text-decoration:underline; cursor:help; }
.highlight-word.found-text { color:#28a745; text-decoration:line-through; }

/* VITÃ“RIA */
.modal-overlay {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.8);
    display: none;
    align-items: center;
    justify-content: center;
    z-index: 5000;
}
.modal-overlay.active { display: flex; }

.win-card {
    background: #fff;
    width: 90%;
    max-width: 380px;
    border-radius: 32px;
    padding: 24px;
    text-align: center;
}

.win-subtitle {
    font-size: 10px;
    color: #777;
    margin-bottom: 8px;
}

.win-title {
    font-size: 22px;
    font-weight: bold;
    margin-bottom: 12px;
}

.win-info {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 12px;
    margin-bottom: 14px;
}

.win-progress {
    padding: 4px 12px;
    border: 2px solid #000;
    border-radius: 12px;
}

.win-divider {
    width: 1px;
    height: 16px;
    background: #ccc;
}

.win-time { font-weight: bold; }

.win-news-title {
    margin-top: 12px;
    font-size: 16px;
    font-weight: bold;
    color: #777;
}

.win-content {
    display: flex;
    gap: 14px;
    margin-top: 12px;
}

.win-thumb {
    width: 90px;
    height: 90px;
    background: #d7dbe2;
    border-radius: 6px;
}

.win-text { text-align: left; }

.win-buttons {
    display: flex;
    gap: 8px;
}

/* botÃ£o */
.btn-primary {
    margin-top: 18px;
    width: 100%;
    background: #D90429;
    color: #fff;
    border: none;
    padding: 12px;
    border-radius: 14px;
    font-size: 18px;
    cursor: pointer;
}

.share-btn {
    margin-top: 12px;
    border: none;
    background: none;
    font-size: 14px;
    cursor: pointer;
    color: #444;
}

/* PAUSE OVERLAY */
#pause-overlay { 
    position:fixed; inset:0; 
    background:rgba(0,0,0,0.85); 
    display:none; 
    align-items:center; justify-content:center; 
    z-index:4000;
}
#pause-overlay.active { display:flex; }

#pause-overlay img {
    width:80px;
    opacity:0.9;
    cursor:pointer;
}

</style>
{% endblock %}

{% block content %}
<div class="caca-container">

    <!-- HEADER -->
    <div class="header-controls">

        <div class="header-left">
            <img src="{% static 'caca_links/img/logo-jcpe.png' %}" class="header-logo" alt="logo">
            <span id="timer">00:00</span>
        </div>

        <div class="header-icons" style="display:flex; align-items:center; gap:14px;">

            <!-- PAUSE BUTTON -->
            <div id="pause-btn" class="pause-square">
                <img id="pause-icon" src="{% static 'noticias/img/icon_pause.svg' %}">
            </div>

            <!-- REGRAS -->
            <img id="btn-rules" src="{% static 'noticias/img/icon_rules.svg' %}">

            <!-- ESTATÃSTICAS -->
            <img id="btn-stats" src="{% static 'noticias/img/icon_stats.svg' %}">

        </div>
    </div>

    <div id="caca-grid"></div>

    <div class="text-section" id="texto-formatado">
        {% autoescape off %}
            {{ texto_da_noticia_formatado }}
        {% endautoescape %}
    </div>

</div>

<!-- MODAL DE VITÃ“RIA -->
<div id="win-modal" class="modal-overlay">
    <div class="win-card">
        <p class="win-subtitle">Desbloqueando um nÃ­vel</p>
        <h2 class="win-title">ParabÃ©ns! Que tal mais uma?</h2>

        <div class="win-info">
            <span class="win-progress">{{ nivel }}/3</span>
            <span class="win-divider"></span>
            <span class="win-time">Tempo: <span id="timer-popup">00:00</span></span>
        </div>

        <h3 class="win-news-title">Tema da notÃ­cia</h3>

        <div class="win-content">
            <div class="win-thumb"></div>
            <div class="win-text">
                <p>{{ caca.noticia.titulo|truncatechars:60 }}</p>
                <div class="win-buttons">
                    <button class="win-icon">ðŸ”–</button>
                    <button class="win-icon">ðŸ”—</button>
                    <button id="go-news" class="win-icon">ðŸ“°</button>
                </div>
            </div>
        </div>

        <button id="next-level" class="btn-primary">
            {% if nivel < 3 %}PrÃ³ximo{% else %}Ir para home{% endif %}
        </button>

        <button class="share-btn">Compartilhar ðŸ”—</button>
    </div>
</div>

<!-- PAUSE OVERLAY -->
<div id="pause-overlay">
    <img id="unpause-icon" src="{% static 'noticias/img/icon_unpause.svg' %}">
</div>

{{ caca.grade|json_script:"grid-data" }}
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener("DOMContentLoaded", () => {

    /* MENU */
    const hamb = document.getElementById("btn-menu");
    const menu = document.getElementById("mobile-menu");
    if (hamb && menu) hamb.addEventListener("click", () => menu.classList.toggle("show"));

    /* TIMER */
    let paused = false;
    const timerEl = document.getElementById("timer");
    const timerPopup = document.getElementById("timer-popup");
    const start = Date.now();

    setInterval(() => {
        if (!paused) {
            const s = Math.floor((Date.now() - start) / 1000);
            const m = String(Math.floor(s/60)).padStart(2,'0');
            const ss = String(s%60).padStart(2,'0');
            timerEl.textContent = `${m}:${ss}`;
            timerPopup.textContent = `${m}:${ss}`;
        }
    }, 1000);

    /* PAUSE */
    const pauseBtn = document.getElementById("pause-btn");
    const pauseOverlay = document.getElementById("pause-overlay");
    const pauseIcon = document.getElementById("pause-icon");

    pauseBtn.addEventListener("click", () => {
        paused = true;
        pauseOverlay.classList.add("active");
        pauseIcon.src = "{% static 'noticias/img/icon_unpause.svg' %}";
    });

    document.getElementById("unpause-icon").addEventListener("click", () => {
        paused = false;
        pauseOverlay.classList.remove("active");
        pauseIcon.src = "{% static 'noticias/img/icon_pause.svg' %}";
    });

    /* GRID */
    const gridData = JSON.parse(
        document.getElementById("grid-data").textContent
    );

    const gridEl = document.getElementById("caca-grid");
    const size = gridData.length;

    gridEl.style.gridTemplateColumns = `repeat(${size}, 1fr)`;
    gridEl.style.gap = "4px";

    for (let r = 0; r < size; r++) {
        for (let c = 0; c < size; c++) {
            const cell = document.createElement("div");
            cell.className = "caca-cell";
            cell.textContent = gridData[r][c];
            gridEl.appendChild(cell);
        }
    }

    const textoEl = document.getElementById("texto-formatado");
    const highlighted = Array.from(textoEl.querySelectorAll(".highlight-word")).map(e => e.dataset.word);

    let selection = [];
    let dragging = false;

    function addCell(cell) {
        if (!cell) return;
        if (!selection.includes(cell)) {
            cell.classList.add("selected");
            selection.push(cell);
        }
    }

    gridEl.addEventListener("mousedown", e => {
        if (!e.target.classList.contains("caca-cell") || paused) return;
        dragging = true;
        addCell(e.target);
    });

    gridEl.addEventListener("mouseover", e => {
        if (dragging && e.target.classList.contains("caca-cell")) addCell(e.target);
    });

    document.addEventListener("mouseup", () => dragging = false);

    /* TOUCH */
    gridEl.addEventListener("touchstart", e => {
        const cell = e.target.closest(".caca-cell");
        if (cell && !paused) {
            dragging = true;
            addCell(cell);
        }
    }, { passive: true });

    gridEl.addEventListener("touchmove", e => {
        if (!dragging) return;
        e.preventDefault();
        const t = e.touches[0];
        const el = document.elementFromPoint(t.clientX, t.clientY);
        const cell = el?.closest(".caca-cell");
        if (cell) addCell(cell);
    }, { passive: false });

    document.addEventListener("touchend", () => dragging = false);

    /* CHECK BUTTON (caso vocÃª adicione de volta no futuro) */
    const checkBtn = document.getElementById("check-btn");
    if (checkBtn) {
        checkBtn.addEventListener("click", () => {
            if (selection.length === 0) return;

            const word = selection.map(c => c.textContent).join("");
            const rev = word.split("").reverse().join("");
            let found = highlighted.find(p => p === word || p === rev);

            if (found) {
                selection.forEach(c => c.classList.add("found"));
                textoEl.querySelectorAll(".highlight-word").forEach(el => {
                    if (el.dataset.word === found) el.classList.add("found-text");
                });
            } else selection.forEach(c => c.classList.remove("selected"));

            selection = [];

            if (!document.querySelector(".highlight-word:not(.found-text)")) {

                paused = true;

                const tempoSegundos = Math.floor((Date.now() - start) / 1000);
                const csrfToken = document.querySelector("meta[name='csrf-token']").content;

                fetch("/caca-links/salvar-tempo/", {
                    method:"POST",
                    headers:{
                        "Content-Type":"application/json",
                        "X-CSRFToken":csrfToken
                    },
                    body:JSON.stringify({
                        tema:"{{ tema.id }}",
                        nivel:"{{ nivel }}",
                        tempo:tempoSegundos
                    })
                });

                document.getElementById("win-modal").classList.add("active");
            }
        });
    }

    const goNewsBtn = document.getElementById("go-news");
    if (goNewsBtn) goNewsBtn.onclick = () =>
        window.location.href = "{{ caca.noticia.get_absolute_url }}";

    const nextBtn = document.getElementById("next-level");
    if (nextBtn) nextBtn.onclick = () => {
        {% if nivel < 3 %}
            window.location.href = "{% url 'caca_links:concluir_nivel' tema.id %}";
        {% else %}
            window.location.href = "{% url 'caca_links:escolher_tema' %}";
        {% endif %}
    };

});
</script>
{% endblock %}
