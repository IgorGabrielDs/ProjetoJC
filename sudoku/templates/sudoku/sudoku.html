{% extends 'base.html' %} 

{% block content %}
<style>
    /* CSS básico para o grid do Sudoku */
    #sudoku-grid {
        display: grid;
        grid-template-columns: repeat(9, 40px);
        grid-template-rows: repeat(9, 40px);
        border: 3px solid #333;
        margin: 20px auto;
        width: 363px; /* 9 * 40px + 2 * 1.5px border */
    }

    .sudoku-cell {
        width: 40px;
        height: 40px;
        border: 1px solid #ccc;
        text-align: center;
        font-size: 24px;
        box-sizing: border-box; /* Importante para o layout */
    }

    .sudoku-cell input {
        width: 100%;
        height: 100%;
        border: none;
        text-align: center;
        font-size: 24px;
        padding: 0;
        box-sizing: border-box;
    }
    
    /* Input das pistas (números iniciais) */
    .sudoku-cell input.clue {
        background-color: #eee;
        color: #333;
        font-weight: bold;
    }

    /* Linhas mais grossas para os blocos 3x3 */
    .sudoku-cell:nth-child(3n) {
        border-right: 2px solid #333;
    }
    .sudoku-cell:nth-child(9n) {
        border-right: 1px solid #ccc; /* Reset no final */
    }
    
    /* Linhas 3 e 6 */
    #sudoku-grid .row-2 .sudoku-cell,
    #sudoku-grid .row-5 .sudoku-cell {
        border-bottom: 2px solid #333;
    }

    /* Estilo para o timer */
    #timer-container {
        font-size: 1.5em;
        font-weight: bold;
        text-align: center;
        margin: 10px 0;
        color: #444;
    }

    #check-button {
        display: block;
        margin: 10px auto;
        padding: 10px 20px;
        font-size: 1.1em;
    }

    #message-area {
        text-align: center;
        font-size: 1.1em;
        margin-top: 10px;
    }
</style>

<h2>Sudoku: Nível {{ puzzle.get_difficulty_display }}</h2>
<p>Complete o fácil para destravar o médio, e o médio para destravar o difícil.</p>

<div id="timer-container">
    Tempo: <span id="timer">00:00</span>
</div>

<div id="sudoku-grid"></div>

<button id="check-button">Verificar Solução</button>
<div id="message-area" style="font-weight: bold;"></div>

{{ problem_board_json|json_script:"problem-board" }}
{{ puzzle.id|json_script:"puzzle-id" }}
{% csrf_token %} <script>
    document.addEventListener('DOMContentLoaded', function() {
        const grid = document.getElementById('sudoku-grid');
        const problemBoard = JSON.parse(document.getElementById('problem-board').textContent);
        const puzzleId = JSON.parse(document.getElementById('puzzle-id').textContent);
        const checkButton = document.getElementById('check-button');
        const messageArea = document.getElementById('message-area');
        const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

        // --- LÓGICA DO TIMER ---
        const timerElement = document.getElementById('timer');
        let startTime = Date.now(); // Grava o tempo exato de início
        let timerInterval;

        function updateTimer() {
            // Calcula o tempo total em segundos
            let elapsedSeconds = Math.floor((Date.now() - startTime) / 1000);
            
            let minutes = Math.floor(elapsedSeconds / 60);
            let seconds = elapsedSeconds % 60;

            // Formata para "MM:SS"
            timerElement.textContent = 
                `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        }

        // Inicia o timer, atualizando a cada segundo
        timerInterval = setInterval(updateTimer, 1000);
        // -------------------------

        // Desenha o tabuleiro
        for (let i = 0; i < 81; i++) {
            const cell = document.createElement('div');
            cell.classList.add('sudoku-cell');
            
            // Adiciona classe para estilizar as linhas dos blocos
            const row = Math.floor(i / 9);
            cell.classList.add(`row-${row}`);

            const input = document.createElement('input');
            input.setAttribute('type', 'text');
            input.setAttribute('maxlength', '1');
            
            const char = problemBoard[i];
            if (char !== '.') {
                // É uma pista (número inicial)
                input.value = char;
                input.readOnly = true; // Não pode ser alterado
                input.classList.add('clue');
            }

            // Validação de input (só permite 1-9)
            input.addEventListener('input', function(e) {
                // Permite apagar o campo ou digitar 1-9
                if (e.target.value === '' || /^[1-9]$/.test(e.target.value)) {
                    // válido
                } else {
                    e.target.value = '';
                }
            });

            cell.appendChild(input);
            grid.appendChild(cell);
        }

        // Lógica para verificar a solução
        checkButton.addEventListener('click', function() {
            let userSolutionStr = '';
            const inputs = grid.querySelectorAll('input');
            
            let isComplete = true;
            inputs.forEach(input => {
                if (input.value === '') {
                    isComplete = false;
                }
                userSolutionStr += (input.value || '.'); // Usa '.' para células vazias
            });

            if (!isComplete) {
                messageArea.textContent = 'Por favor, preencha todas as células.';
                messageArea.style.color = 'red';
                return;
            }

            // Captura o tempo no momento do clique
            let finalElapsedSeconds = Math.floor((Date.now() - startTime) / 1000);

            messageArea.textContent = 'Verificando...';
            messageArea.style.color = '#333';

            // Envia para a view do Django
            fetch("{% url 'sudoku:check_solution' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    'puzzle_id': puzzleId,
                    'solution': userSolutionStr,
                    'elapsed_seconds': finalElapsedSeconds // <-- Envia o tempo para o backend
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Para o timer
                    clearInterval(timerInterval);
                    
                    messageArea.textContent = 'Parabéns! Solução correta!';
                    messageArea.style.color = 'green';
                    
                    // Desabilita o botão para evitar re-envio
                    checkButton.disabled = true;

                    if (data.next_level) {
                        alert('Correto! Você será redirecionado para o próximo nível.');
                        window.location.href = `/sudoku/${data.next_level}/`;
                    } else {
                        alert('Você completou todos os desafios de hoje!');
                    }
                } else {
                    messageArea.textContent = data.message || 'Solução incorreta. Tente novamente!';
                    messageArea.style.color = 'red';
                }
            })
            .catch(error => {
                messageArea.textContent = 'Erro ao verificar. Tente novamente.';
                messageArea.style.color = 'red';
                console.error('Error:', error);
            });
        });
    });
</script>
{% endblock %}