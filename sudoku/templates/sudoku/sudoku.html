{% extends 'base.html' %}
{% load static %}

{% block title %}Jogo Sudoku - {{ difficulty|title }} - JC{% endblock %}

{% block extra_head %}
<style>
    .sudoku-container {
        max-width: 400px; 
        margin: 20px auto;
        padding: 15px;
        background: #fff;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        text-align: center;
    }
    .sudoku-logo {
        width: 100px; 
        height: auto;
        margin: 0 auto 10px auto;
        display: block;
    }
    .sudoku-title {
        font-size: 2em;
        font-weight: bold;
        color: #333;
        margin: 0 0 10px 0;
    }
    .progress-message {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 20px;
    }
    .control-panel {
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
        margin-bottom: 20px;
        padding: 0 5%; 
    }
    .control-item {
        text-align: center;
    }
    .control-label {
        font-size: 0.9em;
        color: #555;
        display: block;
        margin-bottom: 5px;
    }
    .control-value {
        font-size: 1.2em;
        font-weight: bold;
        color: #000;
    }
    #difficulty-selector {
        border: none;
        font-weight: bold;
        font-size: 1.2em;
        font-family: inherit;
        text-align: center;
        background: transparent;
        cursor: pointer;
        -webkit-appearance: none;
        -moz-appearance: none;
        appearance: none;
    }
    .timer-wrapper {
        display: flex;
        flex-direction: row-reverse; 
        align-items: center;
        justify-content: center;
        gap: 8px;
    }
    .pause-icon {
        font-size: 1.5em; 
        font-weight: bold;
        color: #555;
        cursor: pointer;
    }

    /* --- NOVO MÉTODO PARA O GRID --- */
    
    #sudoku-grid {
        display: grid;
        /* Cria um grid 3x3 para os BLOCOS */
        grid-template-columns: repeat(3, 1fr); 
        /* O 'gap' de 2px cria as linhas PRETAS grossas ENTRE os blocos */
        gap: 2px; 
        background-color: black; /* Cor de fundo que preenche o 'gap' */
        /* Borda preta grossa em VOLTA de todo o grid */
        border: 2px solid black; 
        margin: 20px auto;
        max-width: 400px;
        /* Remove o padding para o grid gap funcionar */
        padding: 0; 
    }

    .sudoku-block {
        display: grid;
        /* Cada bloco é um grid 3x3 para as CÉLULAS */
        grid-template-columns: repeat(3, 1fr); 
        /* O 'gap' de 1px cria as linhas CINZAS finas ENTRE as células */
        gap: 1px;
        background-color: #999; /* Cor de fundo que preenche o 'gap' */
    }

    .sudoku-cell {
        width: 100%;
        aspect-ratio: 1 / 1;
        /* Fundo branco para cada célula */
        background-color: #fff; 
        box-sizing: border-box;
        /* Removemos as bordas das células, o 'gap' faz esse trabalho */
    }
    
    /* --- FIM DO NOVO MÉTODO --- */
    
    .sudoku-cell input {
        width: 100%;
        height: 100%;
        border: none;
        text-align: center;
        font-size: 1.5em;
        padding: 0;
        box-sizing: border-box;
        -moz-appearance: textfield;
    }
    .sudoku-cell input::-webkit-outer-spin-button,
    .sudoku-cell input::-webkit-inner-spin-button {
        -webkit-appearance: none;
        margin: 0;
    }
    .sudoku-cell input.clue {
        background-color: #f0f0f0; 
        color: #333;
        font-weight: bold;
    }
    #check-button {
        display: block;
        width: 100%; 
        margin: 20px auto 10px auto;
        padding: 15px 25px;
        font-size: 1.1em;
        font-weight: bold;
        color: #fff;
        background-color: #D90429; 
        border: none;
        border-radius: 8px; 
        cursor: pointer;
    }
    #check-button:disabled {
        background-color: #aaa;
    }
    #message-area {
        font-size: 1.1em;
        font-weight: bold;
        margin-top: 10px;
    }
    #message-area.success { color: green; }
    #message-area.error { color: red; }
</style>
{% endblock %}


{% block content %}
<div class="sudoku-container">
    
    <img src="{% static 'images/logo-jcpe.png' %}" alt="JC PE Logo" class="sudoku-logo">
    
    <h2 class="sudoku-title">Sudoku</h2>
    
    <p class="progress-message">
        {% if progress.completed_difficult %}
            Você completou todos os níveis de hoje!
        {% elif progress.completed_medium %}
            Nível Médio Completo! Próximo: Difícl.
        {% elif progress.completed_easy %}
            Nível Fácil Completo! Próximo: Médio.
        {% else %}
            Complete o fácil para destravar os outros.
        {% endif %}
    </p>

    <div class="control-panel">
        <div class="control-item">
            <span class="control-label">Dificuldade</span>
            <select id="difficulty-selector" class="control-value">
                <option value="easy" {% if difficulty == 'easy' %}selected{% endif %}>Fácil</option>
                <option value="medium" {% if difficulty == 'medium' %}selected{% endif %}>Médio</option>
                <option value="difficult" {% if difficulty == 'difficult' %}selected{% endif %}>Difícil</option>
            </select>
        </div>
        <div class="control-item">
            <span class="control-label">Tempo</span>
            <div class="timer-wrapper">
                <span class="pause-icon">&#9208;</span> 
                <span id="timer" class="control-value">00:00</span>
            </div>
        </div>
    </div>

    {% csrf_token %}

    <div id="sudoku-grid"></div>

    <button id="check-button">Verificar Solução</button>
    <div id="message-area"></div>

    {{ puzzle.id|json_script:"puzzle-id" }}
    {{ problem_board_json|json_script:"problem-board" }}

</div>
{% endblock %}


{% block extra_js %}
    {{ block.super }} 
    
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        const grade = document.getElementById('sudoku-grid');
        
        const tabuleiroProblema = JSON.parse(document.getElementById('problem-board').textContent);
        const desafioId = JSON.parse(document.getElementById('puzzle-id').textContent);
        const botaoVerificar = document.getElementById('check-button');
        const areaMensagem = document.getElementById('message-area');
        
        const tokenCSRF = document.querySelector('[name=csrfmiddlewaretoken]').value;

        const elementoTimer = document.getElementById('timer');
        let inicioTempo = Date.now();
        let intervaloTimer;

        function atualizarTimer() {
            let segundosPassados = Math.floor((Date.now() - inicioTempo) / 1000);
            let minutos = Math.floor(segundosPassados / 60);
            let segundos = segundosPassados % 60;
            elementoTimer.textContent = 
                `${minutos.toString().padStart(2, '0')}:${segundos.toString().padStart(2, '0')}`;
        }
        intervaloTimer = setInterval(atualizarTimer, 1000);

        document.getElementById('difficulty-selector').addEventListener('change', function() {
            const selectedDifficulty = this.value;
            window.location.href = `/sudoku/${selectedDifficulty}/`; 
        });

        
        // --- LÓGICA DE CRIAÇÃO DO GRID (MODIFICADA) ---
        
        // Em vez de 9 linhas, criamos 3x3 blocos
        for (let br = 0; br < 3; br++) { // Linha de Bloco (0 a 2)
            for (let bc = 0; bc < 3; bc++) { // Coluna de Bloco (0 a 2)
                
                const block = document.createElement('div');
                block.classList.add('sudoku-block');
                
                // Agora, criamos 3x3 células DENTRO de cada bloco
                for (let r = 0; r < 3; r++) { // Linha da Célula (0 a 2)
                    for (let c = 0; c < 3; c++) { // Coluna da Célula (0 a 2)
                        
                        // Calcula o índice global de 0 a 80
                        const global_r = br * 3 + r;
                        const global_c = bc * 3 + c;
                        const i = global_r * 9 + global_c;

                        const celula = document.createElement('div');
                        celula.classList.add('sudoku-cell');

                        const campoInput = document.createElement('input');
                        campoInput.setAttribute('type', 'tel'); 
                        campoInput.setAttribute('maxlength', '1');
                        
                        const caractere = tabuleiroProblema[i];
                        if (caractere !== '.') {
                            campoInput.value = caractere;
                            campoInput.readOnly = true;
                            campoInput.classList.add('clue');
                        }

                        campoInput.addEventListener('input', function(e) {
                            if (e.target.value === '' || /^[1-9]$/.test(e.target.value)) {
                            } else {
                                e.target.value = '';
                            }
                        });

                        celula.appendChild(campoInput);
                        block.appendChild(celula);
                    }
                }
                grade.appendChild(block);
            }
        }
        // --- FIM DA LÓGICA DE CRIAÇÃO DO GRID ---


        botaoVerificar.addEventListener('click', function() {
            let solucaoUsuarioStr = '';
            // Esta lógica de verificação continua funcionando
            // pois ainda busca todos os inputs dentro do #sudoku-grid
            const camposInput = grade.querySelectorAll('input');
            
            let estaCompleto = true;
            camposInput.forEach(campo => {
                if (campo.value === '') {
                    estaCompleto = false;
                }
                solucaoUsuarioStr += (campo.value || '0'); 
            });

            if (!estaCompleto) {
                areaMensagem.textContent = 'Por favor, preencha todas as células.';
                areaMensagem.className = 'error';
                return;
            }

            let segundosPassadosFinal = Math.floor((Date.now() - inicioTempo) / 1000);

            areaMensagem.textContent = 'Verificando...';
            areaMensagem.className = '';
            botaoVerificar.disabled = true;

            fetch("{% url 'sudoku:check_solution' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': tokenCSRF
                },
                body: JSON.stringify({
                    'puzzle_id': desafioId,
                    'solution': solucaoUsuarioStr,
                    'elapsed_seconds': segundosPassadosFinal
                })
            })
            .then(resposta => resposta.json())
            .then(dados => {
                if (dados.success) {
                    clearInterval(intervaloTimer);
                    areaMensagem.textContent = 'Parabéns! Solução correta!';
                    areaMensagem.className = 'success';
                    botaoVerificar.disabled = true;

                    if (dados.next_level) {
                        alert('Correto! Você será redirecionado para o próximo nível.');
                        window.location.href = `/sudoku/${dados.next_level}/`;
                    } else {
                        alert('Você completou todos os desafios de hoje!');
                    }
                } else {
                    areaMensagem.textContent = dados.message || 'Solução incorreta. Tente novamente!';
                    areaMensagem.className = 'error';
                    botaoVerificar.disabled = false;
                }
            })
            .catch(erro => {
                areaMensagem.textContent = 'Erro de comunicação. Tente novamente.';
                areaMensagem.className = 'error';
                botaoVerificar.disabled = false;
                console.error('Erro:', erro);
            });
        });
    });
    </script>
{% endblock %}