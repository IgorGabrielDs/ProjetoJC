{% extends 'base.html' %}
{% load static %}

{% block title %}Jogo Sudoku - {{ difficulty|title }} - JC{% endblock %}

{% block extra_head %}
<style>
  .sudoku-container{
    max-width:400px;margin:20px auto;padding:15px;background:#fff;border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);text-align:center;
  }
  .sudoku-logo{width:100px;height:auto;margin:0 auto 10px;display:block;}
  .sudoku-title{font-size:2em;font-weight:bold;color:#333;margin:0 0 10px;}
  .progress-message{font-size:.9em;color:#666;margin-bottom:20px;}

  .control-panel{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding:0 5%;}
  .control-item{text-align:center;}
  .control-label{font-size:.9em;color:#555;display:block;margin-bottom:5px;}
  .control-value{font-size:1.2em;font-weight:bold;color:#000;}
  #difficulty-selector{
    border:none;font-weight:bold;font-size:1.2em;font-family:inherit;text-align:center;
    background:transparent;cursor:pointer;appearance:none;
  }

  #sudoku-grid{
    display:flex;flex-direction:column;gap:2px;background:#000;border:2px solid #000;
    margin:20px auto;max-width:400px;padding:2px;
  }

  .sudoku-row{
    display:grid;
    grid-template-columns:repeat(9,1fr);
    gap:2px;
  }

  .sudoku-cell{
    width:100%;aspect-ratio:1/1;background:#fff;box-sizing:border-box;
    display:flex;align-items:center;justify-content:center;
  }

  .sudoku-cell input{
    width:100%;height:100%;border:none;text-align:center;font-size:1.6em;
    color:#0d47a1;background:transparent;font-family:Arial;
  }

  .sudoku-cell input.clue{
    background:#f0f0f0;color:#333;font-weight:bold;
  }

  #check-button{
    display:block;width:100%;margin:20px auto 10px;padding:15px 25px;font-size:1.1em;font-weight:700;color:#fff;
    background:#D90429;border:none;border-radius:8px;cursor:pointer;
  }

  #message-area{font-size:1.1em;font-weight:bold;margin-top:10px;}
  #message-area.success{color:green;}
  #message-area.error{color:red;}
</style>
{% endblock %}

{% block content %}
<div class="sudoku-container">
  <img src="{% static 'images/logo-jcpe.png' %}" class="sudoku-logo">

  <h2 class="sudoku-title">Sudoku</h2>

  <p class="progress-message">
    {% if progress.completed_hard %}
      Você completou todos os níveis de hoje!
    {% elif progress.completed_medium %}
      Nível Médio completo! Próximo: Difícil.
    {% elif progress.completed_easy %}
      Nível Fácil completo! Próximo: Médio.
    {% else %}
      Complete o fácil para destravar os outros.
    {% endif %}
  </p>

  <div class="control-panel">
    <div class="control-item">
      <span class="control-label">Dificuldade</span>
      <select id="difficulty-selector" class="control-value">
        <option value="easy" {% if difficulty == 'easy' %}selected{% endif %}>Fácil</option>
        <option value="medium" {% if difficulty == 'medium' %}selected{% endif %}>Médio</option>
        <option value="hard" {% if difficulty == 'hard' %}selected{% endif %}>Difícil</option>
      </select>
    </div>

    <div class="control-item">
      <span class="control-label">Tempo</span>
      <span id="timer" class="control-value">00:00</span>
    </div>
  </div>

  {% csrf_token %}
  <div id="sudoku-grid"></div>

  <button id="check-button">Verificar Solução</button>
  <div id="message-area"></div>

  {{ problem_board_json|json_script:"problem-board" }}
  {{ puzzle.id|json_script:"puzzle-id" }}

  {% if puzzle.solution %}
    {{ puzzle.solution|json_script:"solution-board" }}
  {% elif puzzle.solution_board %}
    {{ puzzle.solution_board|json_script:"solution-board" }}
  {% endif %}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}

<script>
document.addEventListener("DOMContentLoaded", () => {

  const grid = document.getElementById("sudoku-grid");

  // ---------------------------
  // CARREGAR O PROBLEMA
  // ---------------------------
  let rawProblem = JSON.parse(document.getElementById("problem-board").textContent);
  rawProblem = rawProblem.replace(/[^0-9.]/g, "");
  if (rawProblem.length !== 81) rawProblem = ".".repeat(81);

  // ---------------------------
  // GERAR GRID LINHA X COLUNA
  // ---------------------------
  for (let r = 0; r < 9; r++) {

    const rowDiv = document.createElement("div");
    rowDiv.className = "sudoku-row";

    for (let c = 0; c < 9; c++) {

      const idx = r * 9 + c;
      const ch = rawProblem[idx];

      const cell = document.createElement("div");
      cell.className = "sudoku-cell";

      const input = document.createElement("input");
      input.type = "text";
      input.maxLength = 1;
      input.inputMode = "numeric";

      input.dataset.row = r;
      input.dataset.col = c;

      if (/[1-9]/.test(ch)) {
        input.value = ch;
        input.readOnly = true;
        input.classList.add("clue");
      }

      input.addEventListener("input", e => {
        if (!/^[1-9]$/.test(e.target.value)) e.target.value = "";
      });

      cell.appendChild(input);
      rowDiv.appendChild(cell);
    }

    grid.appendChild(rowDiv);
  }

  // ---------------------------
  // TIMER
  // ---------------------------
  const timerEl = document.getElementById("timer");
  const start = Date.now();

  setInterval(() => {
    const sec = Math.floor((Date.now() - start) / 1000);
    const mm = String(Math.floor(sec / 60)).padStart(2, "0");
    const ss = String(sec % 60).padStart(2, "0");
    timerEl.textContent = `${mm}:${ss}`;
  }, 1000);

  // ---------------------------
  // ENVIO CORRETO PARA O BACKEND
  // ---------------------------
  const csrf = document.querySelector("[name=csrfmiddlewaretoken]").value;
  const puzzleId = JSON.parse(document.getElementById("puzzle-id").textContent);

  document.getElementById("check-button").addEventListener("click", () => {

    const msg = document.getElementById("message-area");
    let solutionStr = "";

    for (let r = 0; r < 9; r++) {
      for (let c = 0; c < 9; c++) {
        const inp = document.querySelector(`input[data-row="${r}"][data-col="${c}"]`);
        if (!inp || !inp.value) {
          msg.textContent = "Por favor, preencha todas as células.";
          msg.className = "error";
          return;
        }
        solutionStr += inp.value;
      }
    }

    fetch("{% url 'sudoku:check_solution' %}", {
      method: "POST",
      headers: { "Content-Type": "application/json", "X-CSRFToken": csrf },
      body: JSON.stringify({
        puzzle_id: puzzleId,
        solution: solutionStr
      })
    })
    .then(r => r.json())
    .then(d => {
      msg.textContent = d.success ?
        "Parabéns! Solução correta!" :
        (d.message || "Solução incorreta.");
      msg.className = d.success ? "success" : "error";
    });
  });

});
</script>

{% endblock %}