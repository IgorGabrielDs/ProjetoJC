{% extends 'base.html' %}
{% load static %}

{% block title %}Jogo Sudoku - {{ difficulty|title }} - JC{% endblock %}

{% block extra_head %}
<style>
  .sudoku-container{
    max-width:400px;margin:20px auto;padding:15px;background:#fff;border-radius:8px;
    box-shadow:0 2px 10px rgba(0,0,0,.05);text-align:center;
  }
  .sudoku-logo{width:100px;height:auto;margin:0 auto 10px;display:block;}
  .sudoku-title{font-size:2em;font-weight:bold;color:#333;margin:0 0 10px;}
  .progress-message{font-size:.9em;color:#666;margin-bottom:20px;}

  .control-panel{display:flex;justify-content:space-between;align-items:flex-start;margin-bottom:20px;padding:0 5%;}
  .control-item{text-align:center;}
  .control-label{font-size:.9em;color:#555;display:block;margin-bottom:5px;}
  .control-value{font-size:1.2em;font-weight:bold;color:#000;}
  #difficulty-selector{
    border:none;font-weight:bold;font-size:1.2em;font-family:inherit;text-align:center;
    background:transparent;cursor:pointer;appearance:none;
  }
  .timer-wrapper{display:flex;flex-direction:row-reverse;align-items:center;justify-content:center;gap:8px;}
  .pause-icon{font-size:1.5em;font-weight:bold;color:#555;cursor:pointer;}

  #sudoku-grid{
    display:grid;grid-template-columns:repeat(3,1fr);gap:2px;background:#000;border:2px solid #000;
    margin:20px auto;max-width:400px;padding:0;position:relative;
  }
  .sudoku-block{display:grid;grid-template-columns:repeat(3,1fr);gap:1px;background:#999;}
  .sudoku-cell{
    width:100%;aspect-ratio:1/1;background:#fff;box-sizing:border-box;overflow:hidden;
    display:flex;align-items:center;justify-content:center;
  }
  .sudoku-cell input{
    width:100%;height:100%;border:none;text-align:center;font-size:1.6em;font-family:Arial, sans-serif;
    padding:0;box-sizing:border-box;color:#0d47a1;background:transparent;transition:background-color .2s ease;
    -moz-appearance:textfield;overflow:hidden;text-overflow:clip;white-space:nowrap;
  }
  .sudoku-cell input::-webkit-outer-spin-button,
  .sudoku-cell input::-webkit-inner-spin-button{appearance:none;margin:0;}
  .sudoku-cell input.clue{background:#f0f0f0;color:#333;font-weight:bold;}
  .sudoku-cell input:not(.clue):focus{background:#fffde7;outline:2px solid #D90429;outline-offset:-2px;}

  #check-button{
    display:block;width:100%;margin:20px auto 10px;padding:15px 25px;font-size:1.1em;font-weight:700;color:#fff;
    background:#D90429;border:none;border-radius:8px;cursor:pointer;box-shadow:0 2px 5px rgba(0,0,0,.2);
    transition:background-color .3s ease, transform .1s ease;
  }
  #check-button:hover:not(:disabled){background:#b80324;}
  #check-button:active:not(:disabled){transform:scale(.98);}
  #check-button:disabled{background:#aaa;box-shadow:none;cursor:not-allowed;}

  #message-area{font-size:1.1em;font-weight:bold;margin-top:10px;}
  #message-area.success{color:green;}
  #message-area.error{color:red;}
</style>
{% endblock %}

{% block content %}
<div class="sudoku-container">
  <img src="{% static 'images/logo-jcpe.png' %}" alt="JC PE Logo" class="sudoku-logo">
  <h2 class="sudoku-title">Sudoku</h2>

  <p class="progress-message">
    {% if progress.completed_hard %}
      Você completou todos os níveis de hoje!
    {% elif progress.completed_medium %}
      Nível Médio completo! Próximo: Difícil.
    {% elif progress.completed_easy %}
      Nível Fácil completo! Próximo: Médio.
    {% else %}
      Complete o fácil para destravar os outros.
    {% endif %}
  </p>

  <div class="control-panel">
    <div class="control-item">
      <span class="control-label">Dificuldade</span>
      <select id="difficulty-selector" class="control-value" aria-label="Selecionar dificuldade">
        <option value="easy"   {% if difficulty == 'easy' %}selected{% endif %}>Fácil</option>
        <option value="medium" {% if difficulty == 'medium' %}selected{% endif %}>Médio</option>
        <option value="hard"   {% if difficulty == 'hard' %}selected{% endif %}>Difícil</option>
      </select>
    </div>
    <div class="control-item">
      <span class="control-label">Tempo</span>
      <div class="timer-wrapper">
        <span class="pause-icon" aria-hidden="true">&#9208;</span>
        <span id="timer" class="control-value">00:00</span>
      </div>
    </div>
  </div>

  {% csrf_token %}
  <div id="sudoku-grid" aria-label="Tabuleiro de Sudoku"></div>
  <button id="check-button">Verificar Solução</button>
  <div id="message-area" role="status" aria-live="polite"></div>

  {# sempre presente: problema #}
  {{ problem_board_json|json_script:"problem-board" }}
  {{ puzzle.id|json_script:"puzzle-id" }}

  {# opcional: solução (qualquer um dos dois nomes do modelo) #}
  {% if puzzle.solution %}
    {{ puzzle.solution|json_script:"solution-board" }}
  {% elif puzzle.solution_board %}
    {{ puzzle.solution_board|json_script:"solution-board" }}
  {% endif %}

  {# ajuda JS a decidir quantas dicas semear, se necessário #}
  {{ difficulty|json_script:"difficulty-name" }}
</div>
{% endblock %}

{% block extra_js %}
{{ block.super }}
<script>
document.addEventListener('DOMContentLoaded', () => {
  const grid = document.getElementById('sudoku-grid');
  const rawProblem = JSON.parse(document.getElementById('problem-board').textContent);
  const puzzleId = JSON.parse(document.getElementById('puzzle-id').textContent);
  const diffName = JSON.parse(document.getElementById('difficulty-name').textContent);
  const solutionNode = document.getElementById('solution-board');
  const rawSolution = solutionNode ? JSON.parse(solutionNode.textContent) : null;
  const csrf = document.querySelector('[name=csrfmiddlewaretoken]').value;

  // ---- Normalização de formatos ----
  const toFlatString = (data) => {
    // aceita string, array 1D, array 2D (9x9), com pontos ou zeros
    if (typeof data === 'string') return data;
    if (Array.isArray(data)) {
      if (Array.isArray(data[0])) {
        // 2D
        return data.flat().join('');
      }
      // 1D
      return data.join('');
    }
    return '';
  };

  let problem = toFlatString(rawProblem);
  let solution = rawSolution ? toFlatString(rawSolution) : null;

  // saneamento
  const sanitize = (s) => s
    .replace(/[^0-9.]/g, '')   // só 0-9 e '.'
    .replace(/0/g, '.');       // zeros viram vazios
  problem = sanitize(problem);
  if (solution) solution = sanitize(solution);

  // Ajusta tamanho para 81
  const pad81 = (s) => (s && s.length === 81) ? s : '.'.repeat(81);
  problem = pad81(problem);
  if (solution) solution = pad81(solution);

  // ---- Se não há nenhuma dica no "problem", semeia a partir da solução ----
  const countDigits = (s) => (s.match(/[1-9]/g) || []).length;

  if (countDigits(problem) === 0 && solution && countDigits(solution) === 81) {
    // quantidade de dicas por dificuldade (valores típicos)
    const seedsByDiff = { easy: 32, medium: 28, hard: 24 };
    const targetClues = seedsByDiff[diffName] || 28;

    // escolha determinística simples para não mudar a cada refresh:
    // usa um "seed" baseado no puzzleId
    const seededRandom = (() => {
      let seed = Number(String(puzzleId).replace(/\D/g, '').slice(-6)) || 123457;
      return () => {
        seed = (seed * 9301 + 49297) % 233280;
        return seed / 233280;
      };
    })();

    const idxs = Array.from({length:81}, (_,i)=>i);
    // embaralha parcialmente
    for (let i = idxs.length - 1; i > 0; i--) {
      const j = Math.floor(seededRandom() * (i + 1));
      [idxs[i], idxs[j]] = [idxs[j], idxs[i]];
    }

    let arr = problem.split('');
    let planted = 0;
    for (let k = 0; k < idxs.length && planted < targetClues; k++) {
      const i = idxs[k];
      if (arr[i] === '.' && /[1-9]/.test(solution[i])) {
        arr[i] = solution[i];
        planted++;
      }
    }
    problem = arr.join('');
    // agora o tabuleiro tem dicas reais
  }

  // ---- Montagem do grid 9x9 em blocos 3x3 ----
  for (let br = 0; br < 3; br++) {
    for (let bc = 0; bc < 3; bc++) {
      const block = document.createElement('div');
      block.className = 'sudoku-block';

      for (let r = 0; r < 3; r++) {
        for (let c = 0; c < 3; c++) {
          const i = (br * 3 + r) * 9 + (bc * 3 + c);
          const cell = document.createElement('div');
          cell.className = 'sudoku-cell';

          const input = document.createElement('input');
          input.type = 'text';
          input.inputMode = 'numeric';
          input.maxLength = 1;
          input.pattern = '[1-9]';
          input.autocomplete = 'off';
          input.setAttribute('aria-label', `Linha ${br*3+r+1}, coluna ${bc*3+c+1}`);

          const ch = problem[i]; // '.' ou '1'..'9'
          if (/[1-9]/.test(ch)) {
            input.value = ch;
            input.readOnly = true;
            input.classList.add('clue');
          }

          // Permite apenas 1–9
          input.addEventListener('input', (e) => {
            const v = e.target.value;
            if (v === '' || /^[1-9]$/.test(v)) return;
            e.target.value = '';
          });
          input.addEventListener('paste', (e) => {
            const t = (e.clipboardData || window.clipboardData).getData('text');
            if (!/^[1-9]$/.test(t)) e.preventDefault();
          });

          cell.appendChild(input);
          block.appendChild(cell);
        }
      }
      grid.appendChild(block);
    }
  }

  // ---- Timer ----
  const timerEl = document.getElementById('timer');
  const startTime = Date.now();
  setInterval(() => {
    const sec = Math.floor((Date.now() - startTime) / 1000);
    const mm = String(Math.floor(sec / 60)).padStart(2, '0');
    const ss = String(sec % 60).padStart(2, '0');
    timerEl.textContent = `${mm}:${ss}`;
  }, 1000);

  // ---- Troca de dificuldade ----
  document.getElementById('difficulty-selector').addEventListener('change', (e) => {
    window.location.href = `/sudoku/${e.target.value}/`;
  });

  // ---- Verificar solução ----
  const btn = document.getElementById('check-button');
  const msg = document.getElementById('message-area');

  btn.addEventListener('click', () => {
    const inputs = grid.querySelectorAll('input');
    let solutionStr = '';
    let complete = true;

    inputs.forEach(inp => {
      if (inp.value === '') complete = false;
      solutionStr += (inp.value || '.');
    });

    if (!complete) {
      msg.textContent = 'Por favor, preencha todas as células.';
      msg.className = 'error';
      return;
    }

    msg.textContent = 'Verificando...';
    msg.className = '';
    btn.disabled = true;

    fetch("{% url 'sudoku:check_solution' %}", {
      method: 'POST',
      headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrf },
      body: JSON.stringify({
        puzzle_id: puzzleId,
        solution: solutionStr,
        elapsed_seconds: Math.floor((Date.now() - startTime) / 1000)
      })
    })
    .then(r => r.json())
    .then(d => {
      if (d.success) {
        msg.textContent = 'Parabéns! Solução correta!';
        msg.className = 'success';
        if (d.next_level) {
          alert('Correto! Você será redirecionado para o próximo nível.');
          window.location.href = `/sudoku/${d.next_level}/`;
        } else {
          alert('Você completou todos os desafios de hoje!');
        }
      } else {
        msg.textContent = d.message || 'Solução incorreta. Tente novamente!';
        msg.className = 'error';
        btn.disabled = false;
      }
    })
    .catch(err => {
      console.error('Erro:', err);
      msg.textContent = 'Erro de comunicação. Tente novamente.';
      msg.className = 'error';
      btn.disabled = false;
    });
  });
});
</script>
{% endblock %}
